---
phase: 03-transcript-persistence
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - components/SaveTranscript.tsx
  - components/SignInNudge.tsx
  - components/ui/sonner.tsx
  - app/layout.tsx
  - app/page.tsx
  - components/SignInHint.tsx
autonomous: true
requirements:
  - PERS-01
  - PERS-02
  - PERS-03
  - PERS-05

must_haves:
  truths:
    - "Signed-in user generates a transcript and sees 'Transcript saved to history' toast after ~2.5 seconds"
    - "Signed-in user generates a transcript for an already-saved video and sees 'Already in your history' toast"
    - "Unauthenticated user generates and copies a transcript with no save attempt and no errors"
    - "Unauthenticated user sees a sign-in nudge banner below the transcript after it loads"
    - "Save failures are silent -- no error toast, no disruption to the user"
    - "Sign-in nudge is dismissable per session and does not reappear until next visit"
  artifacts:
    - path: "components/SaveTranscript.tsx"
      provides: "Renderless auto-save component with delayed fire and toast feedback"
      min_lines: 40
    - path: "components/SignInNudge.tsx"
      provides: "Contextual sign-in banner with session-based dismiss"
      min_lines: 20
    - path: "components/ui/sonner.tsx"
      provides: "Sonner Toaster wrapper from shadcn CLI"
    - path: "app/layout.tsx"
      provides: "Root layout with Toaster component"
      contains: "Toaster"
    - path: "app/page.tsx"
      provides: "Main page integrating SaveTranscript and SignInNudge"
      contains: "SaveTranscript"
  key_links:
    - from: "components/SaveTranscript.tsx"
      to: "/api/transcript/save"
      via: "fetch POST call inside setTimeout"
      pattern: "fetch.*api/transcript/save"
    - from: "components/SaveTranscript.tsx"
      to: "sonner"
      via: "toast() calls for save feedback"
      pattern: "import.*toast.*from.*sonner"
    - from: "app/page.tsx"
      to: "components/SaveTranscript.tsx"
      via: "Component rendered in success state"
      pattern: "<SaveTranscript"
    - from: "app/page.tsx"
      to: "components/SignInNudge.tsx"
      via: "Component rendered in success state"
      pattern: "<SignInNudge"
    - from: "app/layout.tsx"
      to: "components/ui/sonner.tsx"
      via: "Toaster component in body"
      pattern: "<Toaster"
---

<objective>
Wire client-side auto-save, toast notifications, and contextual sign-in nudge into the existing transcript flow. Install Sonner for toasts, create SaveTranscript renderless component that fires a delayed save for signed-in users, create SignInNudge banner that replaces SignInHint, and integrate everything into the page.

Purpose: This is the user-facing half of transcript persistence. After this plan, signed-in users see their transcripts saved automatically with feedback, and unauthenticated users see a compelling reason to sign in.

Output: Working auto-save flow with toast feedback, contextual sign-in nudge, Sonner toast infrastructure.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transcript-persistence/03-RESEARCH.md
@.planning/phases/03-transcript-persistence/03-01-SUMMARY.md

@app/page.tsx
@app/layout.tsx
@components/SignInHint.tsx
@lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner + SaveTranscript + SignInNudge components</name>
  <files>
    components/ui/sonner.tsx
    components/SaveTranscript.tsx
    components/SignInNudge.tsx
    app/layout.tsx
  </files>
  <action>
1. **Install Sonner via shadcn CLI**:
   ```bash
   npx shadcn@latest add sonner
   ```
   This installs the `sonner` package and creates `components/ui/sonner.tsx`. Verify the file was created.

2. **Add `<Toaster />` to root layout** (`app/layout.tsx`):
   - Import `Toaster` from `@/components/ui/sonner`.
   - Add `<Toaster />` inside the `<body>` element, after `</Providers>` closing tag but still inside `<body>`. Place it as a sibling after `</main>`, before `</Providers>` closing tag (inside Providers so it has access to React context).
   - If the generated `sonner.tsx` has a `theme` prop, check if `theme="system"` works with the `.dark` class on `<html>`. If unclear, just use `<Toaster />` with no theme prop and let Sonner auto-detect via the `.dark` class (it checks `document.documentElement`).

3. **Create `components/SaveTranscript.tsx`**:
   This is a renderless component (returns `null`) that fires the save API call after a 2.5-second delay when a transcript is displayed for a signed-in user.

   Props interface:
   ```typescript
   interface SaveTranscriptProps {
     videoId: string;
     videoUrl: string;
     videoTitle: string;
     thumbnailUrl: string | null;
     videoDuration: number | null;
     segments: TranscriptSegment[];
   }
   ```

   Implementation details:
   - `"use client"` directive.
   - Uses `useSession()` from `next-auth/react` to check auth status.
   - Uses a `useRef<string | null>(null)` (`savedRef`) to track the last videoId for which a save was attempted in this component lifecycle. This prevents re-saving on re-renders (e.g., timestamp toggle, format change).
   - `useEffect` keyed on `[session?.user?.id, props.videoId]` (NOT on `segments` -- avoids re-triggering on language switch per Pitfall 6 in research).
   - Guard: if no `session?.user?.id`, return early (unauthenticated -- no save).
   - Guard: if `savedRef.current === props.videoId`, return early (already attempted this video).
   - Sets a 2500ms `setTimeout`. Inside the callback:
     - Set `savedRef.current = props.videoId` immediately (prevent duplicate attempts even if the first fails).
     - `fetch("/api/transcript/save", { method: "POST", ... })` with the props as JSON body.
     - If `!res.ok`, return silently (per locked decision: save failures are silent).
     - Parse response as `{ inserted: boolean, id: string | null }`.
     - If `inserted === true`: `toast("Transcript saved to history", { action: { label: "View", onClick: () => window.location.href = "/history" } })`. Use `window.location.href` instead of `router.push` to avoid needing `useRouter` -- simpler. The toast action button provides a path to `/history` (Phase 4 will build the page; for now it will 404 or redirect, which is harmless).
     - If `inserted === false`: `toast("Already in your history")`.
   - Catch block: silently swallow errors (per locked decision).
   - `useEffect` cleanup: `clearTimeout(timer)` to prevent firing if the component unmounts or videoId changes before the delay completes (Pitfall 1 in research: race condition on rapid re-submissions).
   - Returns `null` (renderless).

4. **Create `components/SignInNudge.tsx`**:
   A contextual sign-in banner that appears below the transcript for unauthenticated users, encouraging sign-in.

   Implementation:
   - `"use client"` directive.
   - Uses `useSession()` to check auth status.
   - Uses `useState` initialized from `sessionStorage.getItem("signInNudgeDismissed")` to track dismissal.
   - If session exists (signed in) OR status is `"loading"` OR dismissed is true, return `null`.
   - Renders a styled banner (use a `div` with `rounded-lg border bg-muted/50 p-4` styling for a subtle but visible appearance):
     - Copy: "Sign in to automatically save transcripts and build your history" (specific value prop per research recommendation).
     - A sign-in button (use `signIn("google")` from `next-auth/react`).
     - A dismiss button (X icon or "Dismiss" text) that sets `sessionStorage.setItem("signInNudgeDismissed", "true")` and hides the banner.
   - This replaces `SignInHint` in function. The old `SignInHint` component will be removed from `page.tsx` in Task 2.
  </action>
  <verify>
    - `components/ui/sonner.tsx` exists (created by shadcn CLI).
    - `npm run build` passes.
    - `components/SaveTranscript.tsx` exists and imports from `sonner` and `next-auth/react`.
    - `components/SignInNudge.tsx` exists with session-dismissable logic.
    - `app/layout.tsx` includes `<Toaster />`.
  </verify>
  <done>
    - Sonner installed and Toaster added to root layout.
    - SaveTranscript component implements delayed auto-save with toast feedback.
    - SignInNudge component shows contextual sign-in banner for unauthenticated users.
    - All three components ready for integration into the main page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SaveTranscript + SignInNudge into page and remove old SignInHint</name>
  <files>
    app/page.tsx
    components/SignInHint.tsx
  </files>
  <action>
1. **Update `app/page.tsx`**:
   - Import `SaveTranscript` from `@/components/SaveTranscript`.
   - Import `SignInNudge` from `@/components/SignInNudge`.
   - Remove the `import SignInHint from '@/components/SignInHint'` line.
   - The page needs to pass `videoId` and `videoDuration` to `SaveTranscript`. These come from the transcript API response (`TranscriptResult` includes both fields after Plan 01). Add state variables:
     - `const [videoId, setVideoId] = useState('')` -- the extracted video ID.
     - `const [videoDuration, setVideoDuration] = useState<number | null>(null)` -- duration from InnerTube.
   - In `handleSubmit`, after `setSegments(transcriptData.data.segments)`:
     - `setVideoId(transcriptData.data.videoId)` (already in TranscriptResult).
     - `setVideoDuration(transcriptData.data.videoDuration ?? null)`.
   - In the success block (`appState === 'success'`), add `<SaveTranscript>` as the first child inside the fragment:
     ```tsx
     <SaveTranscript
       videoId={videoId}
       videoUrl={url}
       videoTitle={metadata?.title ?? "Untitled"}
       thumbnailUrl={metadata?.thumbnailUrl ?? null}
       videoDuration={videoDuration}
       segments={segments}
     />
     ```
     Note: `videoTitle` falls back to "Untitled" if metadata hasn't loaded. `thumbnailUrl` is nullable.
   - Add `<SignInNudge />` after the `<TranscriptViewer>` component, still inside the success block fragment. This ensures the nudge only appears after a transcript is displayed (per locked decision: users see the value first, then the pitch).
   - Remove `<SignInHint />` from the bottom of the JSX (the old always-visible hint is replaced by the contextual nudge).

2. **Delete or empty `components/SignInHint.tsx`**:
   - Since SignInNudge replaces SignInHint, and no other file imports SignInHint, the file can be deleted. Use `git rm components/SignInHint.tsx` or simply delete it. If other files might reference it (check with grep first), keep the file but export a component that returns null.
   - **Check first**: `grep -r "SignInHint" --include="*.tsx" --include="*.ts"` to confirm only `page.tsx` imports it. If confirmed, safe to delete.

3. **Handle language change save behavior**:
   - In `handleLanguageChange`, do NOT reset `videoId` or `videoDuration` -- these don't change when switching languages. The `SaveTranscript` component's `savedRef` will prevent re-saving the same videoId, which is the correct behavior (language switch shouldn't trigger a new save).
  </action>
  <verify>
    - `npm run build` passes with zero errors.
    - `app/page.tsx` imports `SaveTranscript` and `SignInNudge`, does NOT import `SignInHint`.
    - `<SaveTranscript>` is rendered inside the success block with all required props.
    - `<SignInNudge />` is rendered after `TranscriptViewer` in the success block.
    - `grep -r "SignInHint"` returns no results (old component fully removed).
    - No TypeScript errors related to `videoDuration` or `videoId` state.
  </verify>
  <done>
    - Main page auto-saves transcripts for signed-in users via SaveTranscript component.
    - Sign-in nudge appears contextually after transcript loads for unauthenticated users.
    - Old always-visible SignInHint is removed.
    - Language switching does not trigger duplicate saves.
    - Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero TypeScript errors.
2. Sonner package in `package.json` dependencies.
3. `components/ui/sonner.tsx` exists.
4. `<Toaster />` in `app/layout.tsx`.
5. `SaveTranscript` component fires delayed save and shows toast.
6. `SignInNudge` component shows contextual banner for unauthenticated users.
7. `SignInHint` component removed from codebase.
8. `app/page.tsx` passes videoId, videoDuration, and other props to SaveTranscript.
9. Full auto-save flow: generate transcript -> wait 2.5s -> POST to /api/transcript/save -> toast feedback.
</verification>

<success_criteria>
- Signed-in user generates a transcript and sees "Transcript saved to history" toast after a short delay.
- Re-generating the same video shows "Already in your history" toast.
- Unauthenticated user generates and copies transcripts with no errors and no save attempts.
- Unauthenticated user sees a sign-in nudge banner below the transcript.
- Dismissing the nudge hides it for the rest of the session.
- Save failures are completely silent.
- Build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-transcript-persistence/03-02-SUMMARY.md`
</output>
