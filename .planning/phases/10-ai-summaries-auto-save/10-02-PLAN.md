---
phase: 10-ai-summaries-auto-save
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - extension/utils/messaging.ts
  - extension/utils/types.ts
  - extension/entrypoints/background/index.ts
  - extension/entrypoints/youtube.content/panel.ts
  - extension/entrypoints/youtube.content/style.css
autonomous: false
requirements: [AUTH-02, AI-01, AI-02, AI-03]

must_haves:
  truths:
    - "User sees Transcript and Summary tabs in the panel; Transcript tab is default"
    - "Clicking Summarize generates a bullet-point summary displayed in the Summary tab"
    - "User can toggle between bullet point and paragraph format via segmented control"
    - "Requesting a summary for the same video again loads from localStorage cache instantly"
    - "When a signed-in user fetches a transcript, it auto-saves to their history"
    - "A subtle Saved indicator appears in the panel after successful auto-save"
    - "Unauthenticated users see a sign-in prompt in the Summary tab instead of the Summarize button"
    - "User can copy the summary text to clipboard"
  artifacts:
    - path: "extension/utils/messaging.ts"
      provides: "summarize and autoSave message types in ProtocolMap"
      contains: "summarize"
    - path: "extension/utils/types.ts"
      provides: "SummaryData type for extension-side caching"
      contains: "SummaryData"
    - path: "extension/entrypoints/background/index.ts"
      provides: "summarize handler calling /api/summarize, autoSave handler calling /api/transcript/save"
      contains: "autoSaveTranscript"
    - path: "extension/entrypoints/youtube.content/panel.ts"
      provides: "Tabbed panel UI with transcript/summary tabs, format toggle, saved indicator"
      contains: "tg-tab"
    - path: "extension/entrypoints/youtube.content/style.css"
      provides: "Tab bar, summary tab, segmented control, saved indicator CSS"
      contains: "tg-tab-bar"
  key_links:
    - from: "extension/entrypoints/youtube.content/panel.ts"
      to: "extension/utils/messaging.ts"
      via: "sendMessage('summarize', ...) call from summary tab"
      pattern: "sendMessage.*summarize"
    - from: "extension/entrypoints/background/index.ts"
      to: "/api/summarize"
      via: "fetch to backend summarize endpoint with credentials"
      pattern: "api/summarize"
    - from: "extension/entrypoints/background/index.ts"
      to: "/api/transcript/save"
      via: "autoSaveTranscript with credentials: include"
      pattern: "api/transcript/save"
    - from: "extension/entrypoints/youtube.content/panel.ts"
      to: "extension/entrypoints/background/index.ts"
      via: "sendMessage('autoSave', ...) after transcript fetch"
      pattern: "sendMessage.*autoSave"
---

<objective>
Wire the extension to support AI summaries and auto-save: add summarize and autoSave message handlers in the background service worker, build a tabbed panel UI (Transcript/Summary) with format toggle and saved indicator, and integrate localStorage caching for summaries.

Purpose: Connects the backend summarize API (Plan 01) to the user-facing extension panel. Users can generate and view summaries, toggle formats, and have transcripts auto-saved to their history when signed in.

Output: Complete extension UI with two-tab panel, summary generation, format toggle, auto-save on transcript fetch, and saved indicator.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-summaries-auto-save/10-RESEARCH.md
@.planning/phases/10-ai-summaries-auto-save/10-01-SUMMARY.md

@extension/utils/messaging.ts
@extension/utils/types.ts
@extension/entrypoints/background/index.ts
@extension/entrypoints/youtube.content/panel.ts
@extension/entrypoints/youtube.content/style.css
@extension/entrypoints/youtube.content/index.ts
@extension/utils/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add messaging protocol, types, background handlers, and localStorage cache</name>
  <files>extension/utils/messaging.ts, extension/utils/types.ts, extension/entrypoints/background/index.ts</files>
  <action>
**Update `extension/utils/types.ts`** -- Add summary-related types:

```typescript
export interface SummaryData {
  bullets: string;
  paragraph: string;
}

export interface SummaryResponse {
  success: boolean;
  data?: SummaryData;
  error?: string;
}

export interface SaveResult {
  saved: boolean;
}
```

**Update `extension/utils/messaging.ts`** -- Add new message types to ProtocolMap:

```typescript
interface ProtocolMap {
  getTranscript(data: { videoId: string; languageCode?: string }): TranscriptResponse;
  checkAuth(): { isSignedIn: boolean };
  summarize(data: { videoId: string; transcriptText: string }): SummaryResponse;
  autoSave(data: { videoId: string; transcript: { segments: TranscriptSegment[]; videoId: string }; metadata?: { title: string; author: string } }): SaveResult;
}
```

Import the new types (SummaryResponse, SaveResult, TranscriptSegment) from `./types`.

**Update `extension/entrypoints/background/index.ts`** -- Add two new message handlers:

1. **`summarize` handler:**
   - Use WXT `storage.defineItem` to create a localStorage summary cache:
     ```typescript
     const summaryCache = storage.defineItem<Record<string, SummaryData>>('local:summaryCache', { fallback: {} });
     ```
   - On receive: check localStorage cache first by videoId. If found, return cached result immediately.
   - On cache miss: call `POST ${apiBase}/api/summarize` with `{ videoId, transcriptText }` and `credentials: 'include'`.
   - On success: store result in localStorage cache (with 100-entry LRU eviction -- if cache has 100+ entries, delete the oldest one before adding new), then return `{ success: true, data: { bullets, paragraph } }`.
   - On error (401): return `{ success: false, error: 'Sign in to generate summaries' }`.
   - On error (429): return `{ success: false, error: 'Summary temporarily unavailable' }`.
   - On other error: return `{ success: false, error: 'Failed to generate summary' }`.

2. **`autoSave` handler:**
   - Receives `{ videoId, transcript, metadata }`.
   - First check if already saved: `GET ${apiBase}/api/transcript/check?videoId=${videoId}` with `credentials: 'include'`.
   - If check response has `exists: true`, return `{ saved: false }` (skip silently per user decision).
   - If not exists: `POST ${apiBase}/api/transcript/save` with `credentials: 'include'` and body:
     ```json
     {
       "videoId": videoId,
       "videoUrl": "https://www.youtube.com/watch?v=" + videoId,
       "videoTitle": metadata?.title ?? "Unknown video",
       "thumbnailUrl": null,
       "videoDuration": null,
       "segments": transcript.segments
     }
     ```
   - Return `{ saved: true }` on success, `{ saved: false }` on any error (best-effort, non-blocking).

3. **Modify existing `getTranscript` handler** -- After successful transcript fetch, fire auto-save as a non-blocking side effect:
   - After building the successful TranscriptResponse, check auth state (reuse existing `checkAuthState()`)
   - If signed in, call `autoSaveTranscript(videoId, transcript, metadata)` without awaiting (fire-and-forget with `.catch(() => {})`)
   - The auto-save must NOT delay the transcript response to the content script

Extract the auto-save logic into a standalone `async function autoSaveTranscript(...)` for clarity.
  </action>
  <verify>
Run the WXT type check: `cd extension && npx tsc --noEmit` (or `npm run build` from extension root if available). Verify no TypeScript errors. Verify the ProtocolMap has all four message types. Verify `@google/genai` is NOT imported in any extension file.
  </verify>
  <done>Extension messaging protocol includes summarize and autoSave types. Background service worker handles both message types with proper auth, caching, and error handling. Auto-save fires non-blocking after transcript fetch for signed-in users.</done>
</task>

<task type="auto">
  <name>Task 2: Build tabbed panel UI with summary tab, format toggle, and saved indicator</name>
  <files>extension/entrypoints/youtube.content/panel.ts, extension/entrypoints/youtube.content/style.css</files>
  <action>
**Modify `panel.ts`** -- Refactor the panel to have a two-tab layout (Transcript / Summary):

1. **Tab bar** -- Insert between the header actions row and the body. Two tab buttons: "Transcript" (default active) and "Summary". Clicking a tab shows its content area and hides the other. Use classes `tg-tab-bar`, `tg-tab`, `tg-tab-active`.

2. **Transcript tab content** -- This is the existing body content (loading, error, segments container). Wrap in a `tg-tab-content` div with id `tg-tab-transcript`.

3. **Summary tab content** -- New `tg-tab-content` div with id `tg-tab-summary`, initially hidden (`display: none`). Has multiple states:

   - **Empty state (default, authenticated):** Centered layout with a spark/AI icon (simple SVG), heading "Get a summary of this video", subtitle "AI-generated key takeaways", and a "Summarize" button styled like existing `.tg-panel-btn` but more prominent (slightly larger, primary-ish color).

   - **Not signed in:** Replace the summarize button with a "Sign in to summarize" link that opens the web app (same pattern as the sign-in banner link).

   - **Loading state:** Centered spinner (reuse `.tg-spinner` class) with "Generating summary..." text.

   - **Error state:** When `sendMessage('summarize', ...)` returns `{ success: false }`, call `showToast(response.error ?? 'Failed to generate summary', container)` and revert the summary tab back to the empty CTA state (not the loading state). Errors must NEVER be rendered inline in the summary tab â€” always use toast notifications per locked user decision. The `showToast` function already exists in `panel.ts`.

   - **Summary display:** Shows the summary content with:
     - A row at the top containing: a segmented format toggle (Bullets | Paragraph) and a Copy button (reuse copy icon/pattern from transcript tab).
     - The segmented control uses classes `tg-format-toggle`, `tg-format-option`, `tg-format-active`. Pill-style with subtle background. Default to "Bullets" active.
     - Below the controls: a `tg-summary-content` div that renders either the bullet markdown (each line starting with `- ` rendered as a list item) or the paragraph text.
     - Copy button copies the currently visible format (bullets or paragraph) to clipboard.

4. **Saved indicator** -- After auto-save completes for a transcript, show a subtle saved badge in the panel header (next to the title row or actions row). Use a small checkmark SVG + "Saved" text. Class `tg-saved-indicator`. The indicator appears with a fade-in. Do NOT show a toast for save (per user decision: subtle indicator, not toast).

   To know when auto-save is done: after the transcript fetch succeeds, send a `sendMessage('autoSave', ...)` call. When it returns `{ saved: true }`, insert the saved indicator into the header. If `{ saved: false }` (already existed or failed), do nothing. Also check auth state -- only attempt auto-save if signed in.

5. **Summary persistence** -- Per user decision: if a summary has been generated, auto-save should persist both transcript AND summary to history. After a summary is generated successfully in the summary tab, send another auto-save message that includes the summary data. This means the `autoSave` handler needs to be called again (or the save endpoint needs updating). However, the current `/api/transcript/save` does not accept summary data. Since the summaries are stored in a separate global `summaries` table (Plan 01), and the transcript is already saved by auto-save, the summary is inherently available via the summaries table on the web app side (join by videoId). No additional save call needed for summaries -- they are already persisted when generated via `/api/summarize`.

6. **Tab state on panel reopen** -- When the panel is toggled back on (same video), the tab state should be preserved. Since `hidePanel` uses visibility toggle and the DOM is preserved, tab state naturally persists.

7. **Summary tab clear on destroy** -- `destroyPanel()` already resets module state. Add a `currentSummary` module-level variable (`SummaryData | null`) that gets cleared in the `onRemove` callback alongside existing state resets.

8. **Existing actions row** -- The timestamp toggle, copy, and download buttons should only appear when the Transcript tab is active. Move them inside the transcript tab content (or toggle their visibility on tab switch). The Summary tab has its own copy button and format toggle.

**Update `style.css`** -- Add styles for:

- **Tab bar:** `tg-tab-bar` -- flex row below header, border-bottom, gap between tabs
- **Tabs:** `tg-tab` -- padding, cursor pointer, no border, semi-transparent text. `tg-tab-active` -- full opacity, border-bottom indicator (2-3px solid blue #065fd4 / #3ea6ff dark)
- **Tab content:** `tg-tab-content` -- inherits panel-body scroll behavior
- **Segmented control:** `tg-format-toggle` -- inline-flex pill with subtle bg. `tg-format-option` -- padding, no border, transparent bg. `tg-format-active` -- white bg (light) / subtle white bg (dark), slight shadow
- **Summary empty state:** `tg-summary-empty` -- centered flex column, muted text, icon at top
- **Summary CTA button:** `tg-summarize-btn` -- like `.tg-panel-btn` but slightly larger and with a blue tint (#065fd4 bg, white text)
- **Summary content:** `tg-summary-content` -- text rendering area for bullets (styled `ul` with custom markers) and paragraph
- **Saved indicator:** `tg-saved-indicator` -- small inline-flex with gap, green text (#16a34a), font-size 12px, opacity animation fade-in
- **Summary actions row:** `tg-summary-actions` -- flex row for format toggle + copy button, margin-bottom before content
- Dark mode variants for all new classes using `.tg-dark` parent selector
  </action>
  <verify>
Build the extension: `cd extension && npm run build` (or `npx wxt build`). Verify no build errors. Verify `panel.ts` creates tab bar elements and both tab content areas. Verify `style.css` contains styles for all new classes (tg-tab-bar, tg-tab, tg-format-toggle, tg-summary-empty, tg-summarize-btn, tg-saved-indicator).
  </verify>
  <done>Panel has two tabs (Transcript/Summary). Summary tab shows sign-in prompt for unauthenticated users, CTA for authenticated users, loading state during generation, and formatted summary with bullet/paragraph toggle and copy. Saved indicator appears after auto-save. All styles have dark mode variants.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify AI summaries and auto-save end-to-end</name>
  <files>extension/.output/chrome-mv3</files>
  <action>
Build the extension and deploy the web app for manual verification of the complete AI summaries and auto-save flow.

What was built:
- Backend: /api/summarize endpoint with Gemini SDK, DB caching, auth gate
- Extension: tabbed panel (Transcript/Summary), auto-save on transcript fetch
- localStorage summary cache, format toggle (Bullets/Paragraph), saved indicator
- Both features require authentication. Gemini API key stays server-side.

Prerequisites: Ensure GEMINI_API_KEY is set on Vercel (run `npx vercel env add GEMINI_API_KEY` if not already) and redeploy (`npx vercel --prod --yes`).
  </action>
  <verify>
1. Build the extension: `cd /Users/jakesimpson/Projects/transcriptgrab/extension && npx wxt build`
2. Load the extension in Chrome: chrome://extensions -> Developer mode -> Load unpacked -> select extension/.output/chrome-mv3
3. Navigate to a YouTube video (any video with captions)
4. Click the TranscriptGrab button -> Panel should open with transcript on the Transcript tab
5. Verify two tabs are visible: "Transcript" (active/default) and "Summary"
6. If signed in:
   - Check for a subtle "Saved" indicator in the panel header area (should appear after transcript loads)
   - Visit transcriptgrab.com/history to confirm the transcript appears in your history
   - Click the "Summary" tab -> Should see a "Summarize" CTA button
   - Click "Summarize" -> Should see loading spinner, then bullet-point summary (3-7 points)
   - Toggle to "Paragraph" using the segmented control -> Should show paragraph version
   - Toggle back to "Bullets" -> Should show bullets again
   - Click "Copy" on the summary tab -> Should copy summary to clipboard
   - Close panel, reopen (click button twice) -> Summary tab should still have the cached summary
   - Navigate to a different video -> New panel, summary tab reset to empty state
7. If not signed in:
   - Summary tab should show "Sign in to summarize" instead of the Summarize button
   - No "Saved" indicator should appear
   - Transcript tab should still work normally
8. Verify caching: Summarize the same video again (close/reopen panel or navigate away and back). Second time should load instantly from cache without loading spinner.
9. Check console for errors: Open DevTools -> Console. No errors related to TranscriptGrab.
  </verify>
  <done>AI summaries display correctly in both formats, auto-save creates history entries, caching works, and no console errors.</done>
</task>

</tasks>

<verification>
1. Extension builds without errors (`cd extension && npx wxt build`)
2. Web app builds without errors (`npm run build`)
3. Panel shows two tabs (Transcript and Summary)
4. Summary generation works end-to-end (CTA -> loading -> summary display)
5. Format toggle switches between bullets and paragraph
6. Summary copy works
7. Auto-save creates history entries for signed-in users
8. Saved indicator appears after auto-save
9. Summary caching works (DB + localStorage)
10. Unauthenticated users see sign-in prompt in summary tab
</verification>

<success_criteria>
- Transcript and Summary tabs both function correctly
- AI summaries display 3-7 bullet points by default with paragraph toggle
- Same-video second request loads from cache (no loading spinner)
- Signed-in users get auto-saved transcripts visible on transcriptgrab.com/history
- Saved indicator is subtle (not a toast, not silent)
- Gemini API key is never in the extension bundle
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-summaries-auto-save/10-02-SUMMARY.md`
</output>
