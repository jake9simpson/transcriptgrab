---
phase: 04-history-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/queries.ts
  - app/history/page.tsx
  - components/HistoryCard.tsx
  - components/AuthButton.tsx
  - app/layout.tsx
autonomous: true
requirements: [HIST-01, HIST-02, HIST-03, UIUX-01]

must_haves:
  truths:
    - "Signed-in user navigates to /history and sees saved transcripts as cards"
    - "Each card shows video title, thumbnail, save date, and text preview"
    - "Cards are sorted most recent first"
    - "Signed-in user can reach /history from the avatar dropdown"
    - "Brand text in header links back to home page"
    - "Empty state message displayed when user has no saved transcripts"
  artifacts:
    - path: "lib/db/queries.ts"
      provides: "getUserTranscripts and getTranscriptById query functions"
      exports: ["getUserTranscripts", "getTranscriptById"]
    - path: "app/history/page.tsx"
      provides: "History list page with auth guard and data fetching"
      min_lines: 20
    - path: "components/HistoryCard.tsx"
      provides: "Card component displaying transcript metadata and text preview"
      min_lines: 25
  key_links:
    - from: "app/history/page.tsx"
      to: "lib/db/queries.ts"
      via: "getUserTranscripts(userId) call"
      pattern: "getUserTranscripts"
    - from: "app/history/page.tsx"
      to: "components/HistoryCard.tsx"
      via: "renders HistoryCard for each transcript"
      pattern: "HistoryCard"
    - from: "components/AuthButton.tsx"
      to: "/history"
      via: "Link in dropdown menu"
      pattern: "href.*history"
---

<objective>
Build the history list page where signed-in users see all their saved transcripts as browsable cards, sorted newest first. Wire navigation between the main tool and history.

Purpose: This is the first feature that makes the Phase 2-3 database work visible to users. Users need to see their saved transcripts to trust that auto-save is working.
Output: Working /history page with cards, query functions, and navigation links.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-history-list/04-RESEARCH.md
@lib/db/schema.ts
@lib/db/queries.ts
@lib/db/index.ts
@lib/types.ts
@lib/format.ts
@app/history/page.tsx
@components/AuthButton.tsx
@components/VideoInfo.tsx
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query functions and wire navigation</name>
  <files>
    lib/db/queries.ts
    components/AuthButton.tsx
    app/layout.tsx
  </files>
  <action>
    **In `lib/db/queries.ts`**, add two new query functions below the existing `saveTranscript`:

    1. `getUserTranscripts(userId: string)` -- Select all columns from `transcripts` table where `userId` matches, ordered by `savedAt` desc. Use `db.select().from(transcripts).where(eq(transcripts.userId, userId)).orderBy(desc(transcripts.savedAt))`. Return the full rows including segments (MVP approach per research -- optimize later if needed). Import `eq`, `desc` from `drizzle-orm` and `and` for the next function.

    2. `getTranscriptById(id: string, userId: string)` -- Select from `transcripts` where both `id` and `userId` match (ownership verification). Use `db.select().from(transcripts).where(and(eq(transcripts.id, id), eq(transcripts.userId, userId))).limit(1)`. Return `rows[0] ?? null`.

    **In `components/AuthButton.tsx`**, enable the "History" dropdown item:
    - Import `Link` from `next/link`
    - Replace `<DropdownMenuItem disabled>History</DropdownMenuItem>` with `<DropdownMenuItem asChild><Link href="/history">History</Link></DropdownMenuItem>`

    **In `app/layout.tsx`**, make the brand text a link:
    - Import `Link` from `next/link`
    - Wrap the `<span>TranscriptGrab</span>` in `<Link href="/">...</Link>`
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Check that queries.ts exports both new functions and AuthButton.tsx has the Link import.</verify>
  <done>getUserTranscripts and getTranscriptById functions exist and type-check. AuthButton dropdown has working History link. Brand text links to home.</done>
</task>

<task type="auto">
  <name>Task 2: Build history list page and HistoryCard component</name>
  <files>
    components/HistoryCard.tsx
    app/history/page.tsx
  </files>
  <action>
    **Create `components/HistoryCard.tsx`** as a client component:
    - Import `Card`, `CardContent` from `@/components/ui/card`, `Image` from `next/image`, `Link` from `next/link`, and types from `@/lib/types`
    - Props: `transcript` object with shape matching the transcripts table row (id, videoId, videoUrl, videoTitle, thumbnailUrl, videoDuration, segments, savedAt). Define a `HistoryTranscript` type or use `typeof` inference from the query return type. Simplest: define the prop type inline matching the schema columns.
    - Layout: Wrap entire card in `<Link href={/history/${transcript.id}}>` for HIST-04 navigation
    - Card layout (horizontal flex, similar to VideoInfo.tsx pattern):
      - Left: Thumbnail via `next/image` (width=160, height=90, unoptimized, rounded-md). Conditionally render only when `thumbnailUrl` is not null. When null, show a placeholder div with `bg-muted` and same dimensions.
      - Right: Stack of video title (font-semibold, line-clamp-1), text preview (text-sm text-muted-foreground line-clamp-2), and bottom row with save date + optional duration.
    - Text preview: Join the first segments' text with spaces, slice to 150 chars, append "..." if truncated. Use `decodeHtmlEntities` from `@/lib/format` on each segment text.
    - Date formatting: `new Date(savedAt).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })` for "Feb 18, 2026" format.
    - Duration: If `videoDuration` is not null, display using `formatTimestamp` from `@/lib/format`. Show as a subtle badge/text next to the date.
    - Add hover state: `hover:bg-accent/50 transition-colors` on the Card.

    **Rewrite `app/history/page.tsx`** from the existing stub:
    - Keep it as an async server component
    - Import `auth` from `@/auth`, `redirect` from `next/navigation`, `getUserTranscripts` from `@/lib/db/queries`, `HistoryCard` from `@/components/HistoryCard`, `Link` from `next/link`
    - Auth guard: `const session = await auth(); if (!session?.user?.id) redirect("/");`
    - Fetch: `const transcripts = await getUserTranscripts(session.user.id);`
    - Layout: Page title "Your Transcripts" with a count badge, then card list
    - Empty state: If `transcripts.length === 0`, show a friendly message: "No saved transcripts yet. Grab a transcript to see it here." with a link back to the home page.
    - Map transcripts to `<HistoryCard key={t.id} transcript={t} />` in a vertical stack with `gap-3`
    - Add a "Back to TranscriptGrab" link (or rely on the brand text link from Task 1)
  </action>
  <verify>Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to confirm both pages compile as server/client components correctly.</verify>
  <done>History page renders cards for each saved transcript with title, thumbnail, date, text preview, and duration. Empty state shown when no transcripts exist. Cards link to /history/[id]. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (all pages compile)
3. `lib/db/queries.ts` exports `getUserTranscripts` and `getTranscriptById`
4. `components/HistoryCard.tsx` exists with Card, thumbnail, title, date, preview, and Link
5. `app/history/page.tsx` has auth guard, fetches transcripts, renders cards, handles empty state
6. `components/AuthButton.tsx` has enabled History link (not disabled)
7. `app/layout.tsx` brand text is wrapped in Link to "/"
</verification>

<success_criteria>
- Signed-in user visiting /history sees their saved transcripts as cards sorted newest first
- Cards display video title, thumbnail (or placeholder), save date, text preview, and optional duration
- Empty state message shows for users with no saved transcripts
- History dropdown item in avatar menu navigates to /history
- TranscriptGrab brand text links to home page
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-history-list/04-01-SUMMARY.md`
</output>
