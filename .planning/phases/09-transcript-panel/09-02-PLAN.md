---
phase: 09-transcript-panel
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - extension/entrypoints/youtube.content/panel.ts
  - extension/entrypoints/youtube.content/style.css
  - extension/entrypoints/youtube.content/button.ts
  - extension/entrypoints/youtube.content/index.ts
autonomous: false
requirements: [PANEL-01, PANEL-03, PANEL-04, AUTH-04]

must_haves:
  truths:
    - "Clicking the transcript button opens a panel below the YouTube description area showing the full transcript text"
    - "Panel shows a loading spinner while fetching and a clear error message if the transcript is unavailable"
    - "User can copy the transcript to clipboard and sees a toast confirmation that disappears after 2-3 seconds"
    - "User can download the transcript as a .txt file"
    - "User can toggle timestamps on/off and the copy/download output reflects the current toggle state"
    - "User can close the panel and it stays closed until reopened by clicking the button again"
    - "Panel respects YouTube dark/light theme and updates dynamically when theme changes"
    - "Unauthenticated users see a dismissible sign-in banner at the top of the panel"
    - "Dismissing the sign-in banner persists permanently across sessions via extension storage"
    - "Navigating to a different video closes or resets the panel so stale transcripts are never shown"
  artifacts:
    - path: "extension/entrypoints/youtube.content/panel.ts"
      provides: "Panel creation, rendering, lifecycle, copy, download, toast, sign-in banner"
      exports: ["showPanel", "hidePanel", "isPanelVisible"]
      min_lines: 150
    - path: "extension/entrypoints/youtube.content/style.css"
      provides: "Panel CSS with dark/light theme, loading, error, toast, banner styles"
      contains: "tg-panel"
    - path: "extension/entrypoints/youtube.content/button.ts"
      provides: "Updated click handler that toggles panel open/close"
      contains: "showPanel"
    - path: "extension/entrypoints/youtube.content/index.ts"
      provides: "Panel cleanup on SPA navigation"
      contains: "hidePanel"
  key_links:
    - from: "extension/entrypoints/youtube.content/button.ts"
      to: "extension/entrypoints/youtube.content/panel.ts"
      via: "handleClick calls showPanel/hidePanel toggle"
      pattern: "showPanel|hidePanel"
    - from: "extension/entrypoints/youtube.content/panel.ts"
      to: "extension/utils/messaging.ts"
      via: "sendMessage('getTranscript') to fetch data"
      pattern: "sendMessage.*getTranscript"
    - from: "extension/entrypoints/youtube.content/panel.ts"
      to: "extension/utils/format.ts"
      via: "formatTranscriptText for copy/download output"
      pattern: "formatTranscriptText"
    - from: "extension/entrypoints/youtube.content/index.ts"
      to: "extension/entrypoints/youtube.content/panel.ts"
      via: "hidePanel on SPA navigation to prevent stale transcript"
      pattern: "hidePanel"
---

<objective>
Build the transcript panel UI that opens on YouTube video pages, displays transcript text, and provides copy/download/close functionality with a sign-in prompt for unauthenticated users.

Purpose: This is the core user-facing feature of the extension. Users click the transcript button (from Phase 8) and see a panel with the full transcript they can copy or download. The panel must feel like a native YouTube feature with matching theme support.

Output: Complete panel module with rendering, actions, sign-in banner, and integration with the existing button and content script lifecycle.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-transcript-panel/09-RESEARCH.md
@.planning/phases/09-transcript-panel/09-CONTEXT.md
@.planning/phases/09-transcript-panel/09-01-SUMMARY.md

# Key source files
@extension/entrypoints/youtube.content/button.ts
@extension/entrypoints/youtube.content/index.ts
@extension/entrypoints/youtube.content/style.css
@extension/utils/messaging.ts
@extension/utils/types.ts
@extension/utils/format.ts
@extension/utils/constants.ts
@extension/utils/dom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create panel module with transcript rendering, actions, and sign-in banner</name>
  <files>extension/entrypoints/youtube.content/panel.ts, extension/entrypoints/youtube.content/style.css</files>
  <action>
Create `extension/entrypoints/youtube.content/panel.ts` as the core panel module. This is a vanilla TypeScript module (no React). All DOM is built with `document.createElement`.

**Exports:**
- `showPanel(ctx: ContentScriptContext, videoId: string): Promise<void>` -- creates and mounts the panel
- `hidePanel(): void` -- removes the panel from the DOM
- `isPanelVisible(): boolean` -- returns whether the panel is currently mounted

**Panel structure (DOM hierarchy):**
```
div.tg-panel
  div.tg-panel-banner (sign-in banner, conditional)
    span "Save transcripts to your history -- " + a "Sign in" + button.tg-banner-dismiss "x"
  div.tg-panel-header
    div.tg-panel-title-row
      div.tg-panel-video-info
        div.tg-panel-video-title (video title text)
        div.tg-panel-channel-name (channel name text)
      button.tg-panel-close "x" SVG icon
    div.tg-panel-actions
      label.tg-timestamp-toggle
        input[type=checkbox] + span "Timestamps"
      button.tg-panel-btn.tg-copy-btn (Copy icon + "Copy")
      button.tg-panel-btn.tg-download-btn (Download icon + "Download")
  div.tg-panel-body (scrollable transcript container, max-height 400px)
    div.tg-panel-loading (shown during fetch: spinner + "Loading transcript...")
    div.tg-panel-error (shown on error: error icon + message text)
    div.tg-panel-segments (shown on success: line-by-line transcript segments)
      div.tg-segment * N (one per segment)
        span.tg-segment-timestamp (hidden by default, shown when timestamps toggled on)
        span.tg-segment-text
  div.tg-toast (toast notification, positioned at bottom center of panel)
```

**Panel lifecycle:**
1. `showPanel` is called with the ContentScriptContext and videoId
2. If panel already exists for this videoId, just show it (toggle visibility). If different videoId, destroy and recreate.
3. Wait for anchor element using `waitForElement('ytd-watch-metadata')` with fallback to `waitForElement('#below')`. If neither found, log warning and return.
4. Create a second Shadow DOM UI via `createShadowRootUi(ctx, { name: 'transcriptgrab-panel', position: 'inline', anchor, append: 'after', ... })`
5. Inside `onMount`: build the full panel DOM, set initial loading state, start the transcript fetch
6. Track module-level state: `panelUi` reference, `currentVideoId`, `segments` array, `showTimestamps` boolean

**Loading state:** Show `div.tg-panel-loading` with a CSS spinner and "Loading transcript..." text. Hide header actions (copy/download/timestamp toggle disabled or hidden).

**Transcript fetch flow:**
1. Call `sendMessage('getTranscript', { videoId })` to reach the background service worker
2. On success: hide loading, show `.tg-panel-segments`, render each segment as a `div.tg-segment` with timestamp span + text span. Store segments in module state. Enable header actions.
3. On error: hide loading, show `.tg-panel-error` with the error message. Keep header actions hidden.
4. Set the video title and channel name from the metadata response (fall back to "Unknown video" / "" if metadata unavailable).

**Timestamp toggle:**
- Checkbox in header actions row, default unchecked (timestamps hidden)
- On toggle: iterate all `.tg-segment-timestamp` spans and toggle a `.tg-timestamp-visible` class
- Store `showTimestamps` in module-level variable so copy/download reflect current state

**Copy functionality:**
- On click: call `formatTranscriptText(segments, showTimestamps)` from `extension/utils/format.ts`
- Call `navigator.clipboard.writeText(text)` -- this works because the click handler provides user activation and YouTube is HTTPS
- Show toast "Copied to clipboard" on success
- Wrap in try/catch; on failure show toast "Failed to copy"

**Download functionality:**
- On click: call `formatTranscriptText(segments, showTimestamps)` from `extension/utils/format.ts`
- Create a Blob with `type: 'text/plain'`
- Generate object URL via `URL.createObjectURL(blob)`
- Create hidden anchor element, set `href` to object URL, set `download` to `${sanitizeFilename(videoTitle)}-transcript.txt`
- Append anchor to `document.body` (outside shadow DOM to avoid CSP issues per research), click, remove, revoke URL
- `sanitizeFilename`: replace `[^a-zA-Z0-9_-]` with `_`, collapse multiple underscores, truncate to 100 chars

**Close functionality:**
- Close button (X icon) in panel header
- On click: call `hidePanel()` which removes the shadow root UI via `panelUi.remove()` and sets `panelUi = null`

**Toast notification:**
- `showToast(message: string, container: ShadowRoot)` internal function
- Creates a `div.tg-toast` with the message text, appends to shadow root container
- Uses `requestAnimationFrame` to trigger opacity transition (0 to 1)
- After 2500ms, transitions opacity back to 0, then removes element after 300ms
- If a toast already exists, remove it before showing new one

**Sign-in banner:**
- Uses WXT storage: `const signInBannerDismissed = storage.defineItem<boolean>('local:signInBannerDismissed', { fallback: false })`
- On panel mount: check `await signInBannerDismissed.getValue()` and call `sendMessage('checkAuth', undefined)` to get auth state
- Show banner only if NOT dismissed AND NOT signed in
- Banner contains: benefit text "Save transcripts to your history", a "Sign in" link, and an X dismiss button
- "Sign in" link opens the web app in a new tab: use `window.open(PROD_URL, '_blank')` (simpler than chrome.tabs.create from content script context; works because content scripts can use window.open)
- In dev mode, use DEV_URL instead of PROD_URL for the sign-in link
- Dismiss button: on click, call `await signInBannerDismissed.setValue(true)`, then animate banner out (fade + collapse via CSS classes) and remove from DOM after animation

**YouTube theme detection:**
- On panel mount: check `document.documentElement.hasAttribute('dark')` and apply `.tg-dark` class to panel root
- Set up MutationObserver on `document.documentElement` watching for `dark` attribute changes
- On attribute change: toggle `.tg-dark` class on the panel root
- Clean up observer when panel is removed

**CSS reset inside shadow root:**
- Set `all: initial` on the panel container element to prevent YouTube CSS inheritance
- Then override with explicit font-family, font-size, color, line-height, box-sizing on `.tg-panel`

**Now add all panel CSS to `extension/entrypoints/youtube.content/style.css`** (append after existing button styles):

Panel container (`.tg-panel`):
- `font-family: 'Roboto', Arial, sans-serif; font-size: 14px; color: #0f0f0f; line-height: 1.4`
- `background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; margin: 12px 0; overflow: hidden`
- `box-sizing: border-box; width: 100%`

Dark mode (`.tg-panel.tg-dark`):
- `background: #212121; border-color: #3f3f3f; color: #fff`

Panel header (`.tg-panel-header`):
- `padding: 12px 16px; border-bottom: 1px solid #e5e5e5`
- Dark: `border-color: #3f3f3f`

Title row: flex, space-between, align-items center
- Video title: `font-size: 16px; font-weight: 500; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap`
- Channel name: `font-size: 12px; color: #606060; margin-top: 2px`
- Dark channel name: `color: #aaa`

Close button: `background: none; border: none; cursor: pointer; padding: 4px; color: inherit; border-radius: 50%`
- Hover: `background: rgba(0,0,0,0.05)` / dark hover: `rgba(255,255,255,0.1)`

Actions row: flex, gap 8px, align-items center, margin-top 8px
- Action buttons (`.tg-panel-btn`): pill shape matching YouTube's style -- `height: 32px; padding: 0 12px; border-radius: 16px; border: none; background: rgba(0,0,0,0.05); color: #0f0f0f; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 4px`
- Dark action buttons: `background: rgba(255,255,255,0.1); color: #fff`
- Hover: slightly darker background

Timestamp toggle (`.tg-timestamp-toggle`): `display: inline-flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer; user-select: none; margin-right: auto`
- Checkbox styling: keep native checkbox for simplicity, just ensure proper alignment

Panel body (`.tg-panel-body`): `max-height: 400px; overflow-y: auto; padding: 12px 16px`
- Scrollbar styling for dark mode: `scrollbar-color: #606060 transparent` (`::-webkit-scrollbar` styles)

Loading state (`.tg-panel-loading`): `display: flex; align-items: center; justify-content: center; gap: 8px; padding: 40px 0; color: #606060`
- Spinner: CSS-only spinner using border animation, 20px circle

Error state (`.tg-panel-error`): `text-align: center; padding: 40px 16px; color: #c00`
- Dark error: `color: #f87171`

Segments (`.tg-segment`): `padding: 4px 0; line-height: 1.5`
- Timestamp span (`.tg-segment-timestamp`): `display: none; color: #065fd4; font-family: monospace; font-size: 12px; margin-right: 8px`
- When visible (`.tg-timestamp-visible .tg-segment-timestamp`): `display: inline`
- Dark timestamp: `color: #3ea6ff`

Sign-in banner (`.tg-panel-banner`):
- `padding: 10px 16px; background: rgba(96, 165, 250, 0.08); border-bottom: 1px solid rgba(96, 165, 250, 0.2); display: flex; align-items: center; gap: 8px; font-size: 13px`
- Dark: `background: rgba(96, 165, 250, 0.1); border-color: rgba(96, 165, 250, 0.15)`
- Link: `color: #065fd4; text-decoration: none; font-weight: 500` / dark: `color: #3ea6ff`
- Dismiss button: small X, `background: none; border: none; cursor: pointer; padding: 2px; margin-left: auto; color: #606060; opacity: 0.7`
- Banner dismiss animation: `.tg-panel-banner.tg-banner-hiding { opacity: 0; max-height: 0; padding: 0 16px; overflow: hidden; transition: opacity 0.2s ease, max-height 0.2s ease 0.1s, padding 0.2s ease 0.1s }`

Toast (`.tg-toast`): `position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); background: #323232; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 13px; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 10; white-space: nowrap`
- Visible: `.tg-toast.tg-toast-visible { opacity: 1 }`

Use `px` units exclusively (no rem) -- Shadow DOM inherits the host page's html font-size for rem, which YouTube may change. The panel root needs `position: relative` for the toast absolute positioning to work.

SVG icons: Build small SVG elements (16x16 or 18x18) programmatically with `document.createElementNS` for the close (X), copy, and download icons. Keep them minimal -- use simple paths.
  </action>
  <verify>
Run `cd /Users/jakesimpson/Projects/transcriptgrab/extension && npx tsc --noEmit` to confirm no type errors. Verify `panel.ts` exports `showPanel`, `hidePanel`, `isPanelVisible`. Verify `style.css` contains `.tg-panel`, `.tg-panel-dark`, `.tg-toast`, `.tg-panel-banner` classes.
  </verify>
  <done>
Panel module exists with complete DOM rendering for loading, error, and success states. Copy, download, timestamp toggle, toast, close button, and sign-in banner all functional. CSS matches YouTube's native look in both light and dark themes. Panel uses Shadow DOM isolation. Banner dismissal persists via WXT storage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire button click to panel toggle and handle SPA navigation cleanup</name>
  <files>extension/entrypoints/youtube.content/button.ts, extension/entrypoints/youtube.content/index.ts</files>
  <action>
**Update `extension/entrypoints/youtube.content/button.ts`:**

1. Import `showPanel`, `hidePanel`, `isPanelVisible` from `./panel`
2. Import `ContentScriptContext` type (already imported)
3. Store the `ContentScriptContext` at module level: add a `let ctx: ContentScriptContext | null = null` variable
4. In `injectButton(ctx)`: store the context parameter to the module-level variable so `handleClick` can access it
5. Replace the `handleClick` function:
   - Extract videoId from URL as before
   - If `isPanelVisible()`, call `hidePanel()` and return (toggle off)
   - Otherwise, call `showPanel(ctx!, videoId)` to open the panel
   - Remove the old console.log of the response -- the panel handles display now
   - Keep try/catch; on error, `console.error('[TranscriptGrab] Error:', err)`

**Update `extension/entrypoints/youtube.content/index.ts`:**

1. Import `hidePanel` from `./panel`
2. In the `yt-navigate-finish` event handler, call `hidePanel()` BEFORE calling `tryInject()` -- this ensures stale panels from the previous video are removed before injecting the button for the new video
3. This prevents the pitfall of showing the previous video's transcript after SPA navigation

No changes to the MutationObserver logic -- it only watches for button re-injection, not the panel.
  </action>
  <verify>
Run `cd /Users/jakesimpson/Projects/transcriptgrab/extension && npx tsc --noEmit` to confirm no type errors. Run `npx wxt build` to verify the extension builds successfully. Verify button.ts imports from panel.ts. Verify index.ts calls hidePanel on navigation.
  </verify>
  <done>
Clicking the transcript button toggles the panel open/close. Navigating to a different video via YouTube's SPA navigation closes any open panel. The full data flow works: button click -> panel shows loading -> background fetches transcript -> panel renders segments.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify transcript panel on YouTube</name>
  <files>extension/.output/chrome-mv3</files>
  <action>
Build the extension and load it in Chrome for manual verification of the complete transcript panel feature.

What was built:
- Panel opens below YouTube description when clicking transcript button
- Loading state with spinner during fetch
- Full transcript text displayed line-by-line
- Copy to clipboard with toast notification
- Download as .txt file
- Timestamp toggle (on/off)
- Close button
- YouTube dark/light theme support
- Sign-in banner for unauthenticated users (dismissible, permanent)
- Panel closes on SPA navigation to new video
  </action>
  <verify>
1. Build the extension: `cd /Users/jakesimpson/Projects/transcriptgrab/extension && npx wxt build`
2. Load the extension in Chrome: chrome://extensions -> Developer mode -> Load unpacked -> select `extension/.output/chrome-mv3`
3. Navigate to any YouTube video page (e.g. https://www.youtube.com/watch?v=dQw4w9WgXcQ)
4. Click the "Transcript" button in the actions row
5. Verify: loading spinner appears, then transcript text loads
6. Verify: panel header shows video title and channel name
7. Click "Copy" button -> verify toast "Copied to clipboard" appears and text is in clipboard
8. Click "Download" button -> verify .txt file downloads with video title in filename
9. Toggle "Timestamps" checkbox -> verify timestamps appear/disappear on each segment
10. Copy again with timestamps on -> verify clipboard includes [M:SS] timestamps
11. Click the close button (X) -> verify panel disappears
12. Click transcript button again -> verify panel reopens
13. Navigate to a different video via YouTube sidebar -> verify panel closes
14. Toggle YouTube to dark mode (click profile -> Appearance -> Dark theme) -> verify panel adapts
15. If not signed into transcriptgrab.com: verify sign-in banner appears at top of panel
16. Dismiss the banner -> reload the page -> open panel again -> verify banner does NOT reappear
  </verify>
  <done>All 16 verification steps pass. Panel looks native to YouTube, functions correctly in both themes, and sign-in banner persists dismissal across sessions. Type "approved" to continue or describe issues.</done>
</task>

</tasks>

<verification>
1. Extension builds without errors: `cd extension && npx wxt build`
2. TypeScript compiles: `cd extension && npx tsc --noEmit`
3. Panel opens from button click on YouTube watch pages
4. Loading -> success (or error) state transition works
5. Copy and download produce correct output matching timestamp toggle state
6. Toast appears and disappears after ~2.5 seconds
7. Close button removes the panel
8. SPA navigation closes the panel
9. Dark/light theme is detected and applied
10. Sign-in banner shows for unauthenticated users and dismissal persists
</verification>

<success_criteria>
- Clicking the transcript button opens a panel below the YouTube description area showing the full transcript text
- Panel shows a loading state while fetching and an error message if the transcript is unavailable
- User can copy the transcript to clipboard with a visual confirmation (toast)
- User can download the transcript as a .txt file
- Timestamps are toggleable and reflected in copy/download output
- User can close the panel, and it stays closed until reopened
- Panel respects YouTube dark/light theme
- Unauthenticated users see a non-blocking, permanently dismissible sign-in prompt
- SPA navigation closes stale panels
</success_criteria>

<output>
After completion, create `.planning/phases/09-transcript-panel/09-02-SUMMARY.md`
</output>
