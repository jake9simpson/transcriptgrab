---
phase: 01-auth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - auth.ts
  - proxy.ts
  - app/api/auth/[...nextauth]/route.ts
  - components/Providers.tsx
  - app/layout.tsx
  - .env.local
autonomous: true
requirements:
  - AUTH-01
  - AUTH-03
user_setup:
  - service: google-oauth
    why: "Google OAuth requires client credentials from Google Cloud Console"
    env_vars:
      - name: AUTH_GOOGLE_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: AUTH_GOOGLE_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
      - name: AUTH_SECRET
        source: "Generate locally with: npx auth secret"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth Client ID"
      - task: "Add authorized redirect URIs: http://localhost:3000/api/auth/callback/google (dev) and https://yourdomain.com/api/auth/callback/google (prod)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Edit OAuth Client -> Authorized redirect URIs"
      - task: "Configure OAuth consent screen (External, app name, user support email)"
        location: "Google Cloud Console -> APIs & Services -> OAuth consent screen"

must_haves:
  truths:
    - "Auth.js route handler responds at /api/auth/* endpoints"
    - "JWT session cookie is set after successful sign-in"
    - "Session persists across page refreshes (cookie-based, no database)"
    - "Proxy keeps session token fresh on every matched request"
    - "Unauthenticated requests to /history redirect to home page"
  artifacts:
    - path: "auth.ts"
      provides: "Root Auth.js v5 config with Google provider and JWT strategy"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js catch-all route handler"
      exports: ["GET", "POST"]
    - path: "proxy.ts"
      provides: "Session freshness proxy with protected route redirects"
      exports: ["proxy", "config"]
    - path: "components/Providers.tsx"
      provides: "Client-side SessionProvider wrapper"
      exports: ["default"]
    - path: "app/layout.tsx"
      provides: "Root layout wrapping children in Providers"
      contains: "<Providers>"
  key_links:
    - from: "app/api/auth/[...nextauth]/route.ts"
      to: "auth.ts"
      via: "import { handlers } from '@/auth'"
      pattern: "handlers.*from.*@/auth"
    - from: "proxy.ts"
      to: "auth.ts"
      via: "import { auth } from '@/auth'"
      pattern: "auth.*from.*@/auth"
    - from: "app/layout.tsx"
      to: "components/Providers.tsx"
      via: "Providers component wrapping children"
      pattern: "<Providers>"
    - from: "components/Providers.tsx"
      to: "next-auth/react"
      via: "SessionProvider from next-auth/react"
      pattern: "SessionProvider"
---

<objective>
Set up Auth.js v5 infrastructure: root config with Google OAuth provider, JWT session strategy, catch-all route handler, session freshness proxy with protected route redirection, and SessionProvider wrapper integrated into the root layout.

Purpose: Establish the auth foundation so that sign-in/sign-out flows work and sessions persist across page refreshes. All subsequent auth UI depends on this infrastructure.
Output: Working Auth.js backend that handles OAuth callbacks, manages JWT sessions via HttpOnly cookies, protects routes via proxy, and exposes session context to client components.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation/01-RESEARCH.md
@.planning/phases/01-auth-foundation/01-CONTEXT.md
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Auth.js config with route handler</name>
  <files>
    auth.ts
    app/api/auth/[...nextauth]/route.ts
    .env.local
  </files>
  <action>
    1. Install dependencies:
       ```bash
       npm install next-auth@beta
       npx shadcn@latest add avatar dropdown-menu
       ```
       The shadcn components are installed now (Plan 02 needs them) to avoid running the installer twice.

    2. Create `.env.local` with placeholder values (user will fill in real values from Google Cloud Console):
       ```
       AUTH_SECRET="generate-with-npx-auth-secret"
       AUTH_GOOGLE_ID="your-google-client-id"
       AUTH_GOOGLE_SECRET="your-google-client-secret"
       ```
       Also run `npx auth secret` to generate a real AUTH_SECRET and replace the placeholder.

    3. Create `auth.ts` at project root:
       - Import `NextAuth` from `"next-auth"` and `Google` from `"next-auth/providers/google"`
       - Export `{ handlers, auth, signIn, signOut }` from `NextAuth({...})`
       - Configure: `providers: [Google]` (auto-detects AUTH_GOOGLE_ID and AUTH_GOOGLE_SECRET env vars)
       - Configure: `session: { strategy: "jwt", maxAge: 30 * 24 * 60 * 60 }` (30-day sessions)
       - Add `callbacks.jwt` to persist `user.id` into the token
       - Add `callbacks.session` to expose `token.id` as `session.user.id`
       - No database adapter (JWT-only for Phase 1)

    4. Create `app/api/auth/[...nextauth]/route.ts`:
       - Import `{ handlers }` from `"@/auth"`
       - Export `{ GET, POST }` from `handlers`
       - This is the standard Auth.js catch-all route handler pattern
  </action>
  <verify>
    - `auth.ts` exists at project root and exports `handlers`, `auth`, `signIn`, `signOut`
    - `app/api/auth/[...nextauth]/route.ts` exists and exports `GET`, `POST`
    - `.env.local` exists with all three env vars
    - `npm ls next-auth` shows next-auth installed
    - `ls components/ui/avatar.tsx components/ui/dropdown-menu.tsx` confirms shadcn components added
  </verify>
  <done>
    Auth.js v5 is configured with Google provider and JWT sessions. Route handler is ready to accept OAuth callbacks at /api/auth/*. Environment variables are templated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create proxy, Providers wrapper, and update root layout</name>
  <files>
    proxy.ts
    components/Providers.tsx
    app/layout.tsx
  </files>
  <action>
    1. Create `proxy.ts` at project root (Next.js 16 pattern -- NOT middleware.ts):
       - Import `auth` from `"@/auth"`
       - Export `const proxy = auth((req) => { ... })` -- this is the Auth.js proxy wrapper
       - Inside the callback: define `protectedPaths = ["/history", "/settings"]`
       - Check if `req.nextUrl.pathname` starts with any protected path
       - If protected AND `!req.auth`, return `Response.redirect(new URL("/", req.nextUrl.origin))`
       - Export `config` with matcher: `["/((?!api|_next/static|_next/image|favicon.ico).*)"]`
       - The proxy keeps the JWT cookie fresh on every matched request automatically

    2. Create `components/Providers.tsx`:
       - Mark as `"use client"` (required for SessionProvider)
       - Import `SessionProvider` from `"next-auth/react"`
       - Export default function `Providers({ children }: { children: React.ReactNode })`
       - Return `<SessionProvider>{children}</SessionProvider>`

    3. Update `app/layout.tsx`:
       - Import `Providers` from `"@/components/Providers"`
       - Wrap the `<body>` contents (header + main) inside `<Providers>` component
       - Keep the existing theme script in `<head>` unchanged
       - Keep the existing ThemeToggle in the header unchanged (Plan 02 will add AuthButton next to it)
       - Preserve all existing classes, structure, and metadata

    4. Run `npm run build` to verify no TypeScript or build errors.
  </action>
  <verify>
    - `proxy.ts` exists at project root with `export const proxy` and `export const config`
    - `components/Providers.tsx` exists with `"use client"` directive and SessionProvider
    - `app/layout.tsx` has `<Providers>` wrapping body contents
    - `npm run build` succeeds without errors
  </verify>
  <done>
    Session freshness proxy runs on every matched request. Protected routes (/history, /settings) redirect unauthenticated users to home. SessionProvider wraps the entire app so `useSession()` works in any client component. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `auth.ts` exports auth, handlers, signIn, signOut
3. Route handler exists at `app/api/auth/[...nextauth]/route.ts`
4. `proxy.ts` exists (not middleware.ts) with correct export name
5. `components/Providers.tsx` wraps children in SessionProvider
6. `app/layout.tsx` wraps body in `<Providers>`
7. `.env.local` contains AUTH_SECRET, AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET
</verification>

<success_criteria>
Auth.js v5 backend infrastructure is complete: Google OAuth provider configured, JWT sessions enabled (30-day maxAge), route handler handles /api/auth/* requests, proxy keeps sessions fresh and protects /history and /settings routes, and SessionProvider wraps the app for client-side session access. Build passes with no errors.
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation/01-01-SUMMARY.md`
</output>
