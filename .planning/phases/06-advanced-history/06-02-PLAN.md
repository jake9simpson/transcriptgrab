---
phase: 06-advanced-history
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/download.ts
  - components/TranscriptDetail.tsx
  - app/history/[id]/page.tsx
autonomous: true
requirements:
  - HIST-09
  - HIST-10
  - UIUX-02

must_haves:
  truths:
    - "User can toggle timestamp visibility on the history detail page transcript viewer"
    - "User can select between Plain Text, With Timestamps, and SRT formats on the detail page"
    - "User can copy the transcript in the currently selected format"
    - "User can download the transcript as .txt (plain or timestamps) or .srt based on selected format"
    - "Switching formats does not trigger any network request"
  artifacts:
    - path: "lib/download.ts"
      provides: "Shared downloadFile and sanitizeFilename utilities"
      exports: ["downloadFile", "sanitizeFilename"]
    - path: "components/TranscriptDetail.tsx"
      provides: "Client wrapper managing format and timestamp state, rendering actions + viewer"
      contains: "use client"
    - path: "app/history/[id]/page.tsx"
      provides: "Server component using TranscriptDetail wrapper"
      contains: "TranscriptDetail"
  key_links:
    - from: "components/TranscriptDetail.tsx"
      to: "lib/format.ts"
      via: "formatTranscriptText and generateSRT for copy/download"
      pattern: "formatTranscriptText|generateSRT"
    - from: "components/TranscriptDetail.tsx"
      to: "lib/download.ts"
      via: "downloadFile for .txt and .srt export"
      pattern: "downloadFile"
    - from: "components/TranscriptDetail.tsx"
      to: "components/TranscriptViewer.tsx"
      via: "showTimestamps prop controlled by format state"
      pattern: "showTimestamps"
    - from: "app/history/[id]/page.tsx"
      to: "components/TranscriptDetail.tsx"
      via: "server component passes segments and metadata as props"
      pattern: "TranscriptDetail"
---

<objective>
Add format switching, transcript export, and timestamp toggle to the history detail page.

Purpose: Users viewing a saved transcript need the same format flexibility as the main page -- toggle timestamps, switch between plain text / timestamps / SRT, and download in any format. All format conversion is client-side from stored JSONB segments, zero re-fetching.
Output: New TranscriptDetail client wrapper, shared download utility, updated detail page.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@components/TranscriptDetailActions.tsx
@components/TranscriptViewer.tsx
@components/TimestampToggle.tsx
@components/ActionButtons.tsx
@app/history/[id]/page.tsx
@lib/format.ts
@components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract download utilities and create TranscriptDetail wrapper</name>
  <files>
    lib/download.ts
    components/TranscriptDetail.tsx
  </files>
  <action>
**Step 1: Create `lib/download.ts`**

Extract the `downloadFile` and `sanitizeFilename` functions from `components/ActionButtons.tsx` into a shared utility:

```typescript
export function sanitizeFilename(name: string): string {
  return name.replace(/[<>:"/\\|?*]+/g, "").replace(/\s+/g, " ").trim() || "transcript";
}

export function downloadFile(content: string, filename: string, mimeType: string) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
```

Do NOT modify `ActionButtons.tsx` in this plan (it still works fine with its local copies). A future cleanup can deduplicate.

**Step 2: Create `components/TranscriptDetail.tsx`**

Create a "use client" component that wraps the entire interactive portion of the detail page. It manages shared state for format selection and timestamp toggle, and renders actions + viewer.

Props interface:
```typescript
interface TranscriptDetailProps {
  transcriptId: string;
  videoTitle: string;
  segments: TranscriptSegment[];
}
```

State:
```typescript
type TranscriptFormat = "plain" | "timestamps" | "srt";
const [format, setFormat] = useState<TranscriptFormat>("plain");
const [copied, setCopied] = useState(false);
const [deleting, setDeleting] = useState(false);
const router = useRouter();

// Derive showTimestamps from format
const showTimestamps = format === "timestamps";
```

Imports needed:
- `useState` from react
- `useRouter` from next/navigation
- `toast` from sonner
- `Copy, Trash2, Check, Download` from lucide-react
- `Button` from `@/components/ui/button`
- `Select, SelectContent, SelectItem, SelectTrigger, SelectValue` from `@/components/ui/select`
- `AlertDialog` and related from `@/components/ui/alert-dialog`
- `TranscriptViewer` from `@/components/TranscriptViewer`
- `TimestampToggle` from `@/components/TimestampToggle`
- `formatTranscriptText, generateSRT` from `@/lib/format`
- `downloadFile, sanitizeFilename` from `@/lib/download`
- `TranscriptSegment` type from `@/lib/types`

Handler functions:

```typescript
function handleCopy() {
  let text: string;
  if (format === "srt") {
    text = generateSRT(segments);
  } else {
    text = formatTranscriptText(segments, format === "timestamps");
  }
  navigator.clipboard.writeText(text).then(() => {
    toast("Copied to clipboard");
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  });
}

function handleDownload() {
  const baseName = sanitizeFilename(videoTitle);
  if (format === "srt") {
    downloadFile(generateSRT(segments), `${baseName}.srt`, "text/srt");
  } else {
    const text = formatTranscriptText(segments, format === "timestamps");
    downloadFile(text, `${baseName}.txt`, "text/plain");
  }
}

async function handleDelete() {
  setDeleting(true);
  try {
    const res = await fetch("/api/transcript/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ids: [transcriptId] }),
    });
    if (res.ok) {
      toast("Transcript deleted");
      router.push("/history");
    } else {
      toast("Failed to delete transcript");
    }
  } catch {
    toast("Failed to delete transcript");
  } finally {
    setDeleting(false);
  }
}
```

JSX layout (top to bottom):
1. **Actions bar** (`flex items-center gap-2 flex-wrap`):
   - Format `Select` (w-[180px]) with three options: "Plain Text" (value="plain"), "With Timestamps" (value="timestamps"), "SRT Subtitles" (value="srt")
   - `TimestampToggle` wired to a local toggle that sets format to "timestamps" when enabled, "plain" when disabled. BUT only toggle between plain/timestamps -- if format is "srt", toggling timestamps should switch to "timestamps" (on) or "plain" (off). Implementation: `onToggle={(enabled) => setFormat(enabled ? "timestamps" : "plain")}`.
   - Copy button (same pattern as existing TranscriptDetailActions)
   - Download button with `Download` icon
   - Delete button with AlertDialog confirmation (same pattern as existing TranscriptDetailActions)

2. **TranscriptViewer** with `segments={segments}` and `showTimestamps={showTimestamps}`.

IMPORTANT: The format Select and TimestampToggle must stay in sync. When user picks "timestamps" from Select, the toggle should show as enabled. When user picks "plain" from Select, toggle is disabled. When user picks "srt", toggle is disabled (SRT controls copy/download only; viewer shows plain text since SRT rendering is not supported by TranscriptViewer).

Sync logic: `showTimestamps = format === "timestamps"`. The TimestampToggle's `enabled` prop is `format === "timestamps"`. Its `onToggle` callback sets format to "timestamps" or "plain".

When format is "srt", the viewer shows plain text (showTimestamps=false). The user can switch to "timestamps" via the toggle to see timestamps in the viewer AND get timestamp-formatted copy/download. The format Select is the primary control; the toggle is a convenience shortcut for timestamps.
  </action>
  <verify>Run `npm run build` -- no type errors. Verify `lib/download.ts` exports two functions. Verify `TranscriptDetail.tsx` imports from format.ts, download.ts, TranscriptViewer, TimestampToggle, and shadcn Select.</verify>
  <done>Shared download utility exists. TranscriptDetail client wrapper manages format/timestamp state and renders format select, timestamp toggle, copy/download/delete actions, and TranscriptViewer.</done>
</task>

<task type="auto">
  <name>Task 2: Wire TranscriptDetail into the detail page</name>
  <files>app/history/[id]/page.tsx</files>
  <action>
Update the detail page server component to use the new TranscriptDetail wrapper:

1. Replace import of `TranscriptDetailActions` with import of `TranscriptDetail` from `@/components/TranscriptDetail`.
2. Remove import of `TranscriptViewer` (now rendered inside TranscriptDetail).
3. Keep all server-side logic (auth, data fetching, notFound) unchanged.
4. Keep the back link and video info header unchanged.
5. Replace both `<TranscriptDetailActions ... />` and `<TranscriptViewer ... />` with a single:
```tsx
<TranscriptDetail
  transcriptId={transcript.id}
  videoTitle={transcript.videoTitle}
  segments={segments}
/>
```

The existing `TranscriptDetailActions` component is no longer used on this page. Do NOT delete the file -- it may be referenced elsewhere or useful as reference. Just remove its import from this page.
  </action>
  <verify>Run `npm run build` -- no type errors, no build failures. Verify the detail page imports TranscriptDetail and does NOT import TranscriptDetailActions or TranscriptViewer directly.</verify>
  <done>Detail page renders TranscriptDetail wrapper with format switching, timestamp toggle, copy, download, and delete capabilities. All format switching is client-side with zero re-fetching.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Detail page shows format Select dropdown with Plain Text, With Timestamps, SRT options
3. Selecting "With Timestamps" shows timestamps in viewer and copies/downloads with timestamps
4. Selecting "SRT Subtitles" copies/downloads in SRT format; viewer shows plain text
5. TimestampToggle syncs with format select (enabled when "With Timestamps" selected)
6. Download produces correct file extension (.txt for plain/timestamps, .srt for SRT)
7. Copy writes correct format to clipboard
8. Delete still works with confirmation dialog
9. No network requests when switching formats (all client-side from JSONB segments)
</verification>

<success_criteria>
History detail page has a format selector (plain/timestamps/SRT), a timestamp toggle synced with the selector, copy and download buttons that respect the selected format, and delete with confirmation. All format switching is instant and client-side.
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-history/06-02-SUMMARY.md`
</output>
