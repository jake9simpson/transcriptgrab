---
phase: 08-extension-foundation
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - extension/entrypoints/youtube.content/index.ts
  - extension/entrypoints/youtube.content/button.ts
  - extension/entrypoints/youtube.content/style.css
  - extension/utils/dom.ts
  - extension/entrypoints/popup/index.html
  - extension/entrypoints/popup/main.ts
  - extension/entrypoints/popup/style.css
autonomous: false
requirements: [EXT-02, EXT-03, AUTH-05]

must_haves:
  truths:
    - "Transcript button appears in YouTube's actions row below the video player on /watch pages"
    - "Button styled as a pill-shaped element matching YouTube's native Like/Share/Download buttons"
    - "Button persists when navigating between videos via SPA navigation without flicker"
    - "Button does not appear on non-watch pages (home, search, Shorts)"
    - "Clicking the button triggers a message-passing round trip to the background service worker"
    - "Extension works without errors when user is not signed into transcriptgrab.com"
    - "Popup shows signed-in/not connected status and version info"
  artifacts:
    - path: "extension/entrypoints/youtube.content/index.ts"
      provides: "Content script entry with SPA navigation handling"
      contains: "defineContentScript"
    - path: "extension/entrypoints/youtube.content/button.ts"
      provides: "Button creation and Shadow DOM injection"
      contains: "createShadowRootUi"
    - path: "extension/entrypoints/youtube.content/style.css"
      provides: "YouTube-native button CSS in px units"
      contains: "tg-transcript-btn"
    - path: "extension/utils/dom.ts"
      provides: "waitForElement utility with MutationObserver"
      exports: ["waitForElement"]
    - path: "extension/entrypoints/popup/index.html"
      provides: "Popup HTML structure"
      contains: "TranscriptGrab"
    - path: "extension/entrypoints/popup/main.ts"
      provides: "Popup logic with auth status display"
      contains: "sendMessage"
    - path: "extension/entrypoints/popup/style.css"
      provides: "Popup styles matching web app dark theme"
      contains: "background"
  key_links:
    - from: "extension/entrypoints/youtube.content/index.ts"
      to: "extension/entrypoints/youtube.content/button.ts"
      via: "injectButton import"
      pattern: "import.*injectButton.*from.*button"
    - from: "extension/entrypoints/youtube.content/index.ts"
      to: "extension/utils/dom.ts"
      via: "waitForElement import"
      pattern: "import.*waitForElement.*from.*dom"
    - from: "extension/entrypoints/youtube.content/button.ts"
      to: "extension/utils/messaging.ts"
      via: "sendMessage for getTranscript"
      pattern: "sendMessage.*getTranscript"
    - from: "extension/entrypoints/popup/main.ts"
      to: "extension/utils/messaging.ts"
      via: "sendMessage for checkAuth"
      pattern: "sendMessage.*checkAuth"
---

<objective>
Build the YouTube content script with button injection, SPA navigation handling, and the toolbar popup -- completing the user-visible extension experience.

Purpose: Delivers all remaining Phase 8 requirements: the transcript button on YouTube pages, SPA navigation persistence, and the popup status display. After this plan, the extension is feature-complete for Phase 8.

Output: Content script that injects a YouTube-native transcript button, survives SPA navigation, and communicates with the background service worker via message passing. Toolbar popup shows auth status and version.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-extension-foundation/08-RESEARCH.md
@.planning/phases/08-extension-foundation/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Content script with button injection, Shadow DOM styling, and SPA navigation</name>
  <files>
    extension/entrypoints/youtube.content/index.ts
    extension/entrypoints/youtube.content/button.ts
    extension/entrypoints/youtube.content/style.css
    extension/utils/dom.ts
  </files>
  <action>
    Create the YouTube content script that injects a transcript button into YouTube's video actions row, handles SPA navigation, and uses Shadow DOM for CSS isolation.

    1. **Create `utils/dom.ts`** with the waitForElement utility:
       ```typescript
       export function waitForElement(selector: string, timeout = 5000): Promise<Element | null> {
         return new Promise((resolve) => {
           const el = document.querySelector(selector);
           if (el) return resolve(el);

           const observer = new MutationObserver(() => {
             const el = document.querySelector(selector);
             if (el) {
               observer.disconnect();
               resolve(el);
             }
           });
           observer.observe(document.body, { childList: true, subtree: true });
           setTimeout(() => {
             observer.disconnect();
             resolve(null);
           }, timeout);
         });
       }
       ```
       Uses MutationObserver (not polling) for efficiency. 5-second timeout prevents indefinite waiting if YouTube changes its DOM structure.

    2. **Create `entrypoints/youtube.content/style.css`** with YouTube-native button styling:
       All CSS must use `px` units (not rem) because this renders inside a Shadow DOM where rem is relative to YouTube's html font-size. The button should match YouTube's native pill-shaped action buttons:
       - Pill shape with rounded corners (~18px border-radius for the standard YouTube pill)
       - Height matches YouTube's action buttons (~36px)
       - Font matches YouTube's typography: Roboto, 14px, 500 weight
       - Two color schemes for YouTube dark/light theme:
         - Dark theme: background ~rgba(255,255,255,0.1), text white, hover ~rgba(255,255,255,0.2)
         - Light theme: background ~rgba(0,0,0,0.05), text #0f0f0f, hover ~rgba(0,0,0,0.1)
       - Flex layout with gap for icon + "Transcript" label
       - SVG icon sized at 20x20px
       - Cursor pointer, no border, smooth transition on hover
       - Use a `.tg-dark` class on the button for dark theme variant. The content script will detect YouTube's theme and apply this class.

    3. **Create `entrypoints/youtube.content/button.ts`:**
       Uses WXT's `createShadowRootUi` for CSS-isolated injection.

       ```typescript
       import { ContentScriptContext, createShadowRootUi } from 'wxt/client';
       import { sendMessage } from '@/utils/messaging';
       import { ANCHOR_SELECTOR, FALLBACK_ANCHOR_SELECTOR } from '@/utils/constants';
       import { waitForElement } from '@/utils/dom';
       ```

       Implementation details:
       - `injectButton(ctx: ContentScriptContext)` is the main export
       - Wait for anchor element using `waitForElement(ANCHOR_SELECTOR)`. If not found, try `FALLBACK_ANCHOR_SELECTOR`. If neither found, log warning and return null.
       - Use `createShadowRootUi(ctx, { name: 'transcriptgrab-button', position: 'inline', anchor: anchorElement, append: 'last', onMount, onRemove })` with `cssInjectionMode: 'ui'`
       - In `onMount(container)`: create button element with class `tg-transcript-btn`, detect YouTube theme via `document.documentElement.hasAttribute('dark')` and add `tg-dark` class if dark theme
       - Button inner HTML: inline SVG of the Lucide `file-text` icon (path data: `M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z` and `M14 2v4a2 2 0 0 0 2 2h4` and three short horizontal lines for text) + span with text "Transcript". Build using `document.createElement` and `document.createElementNS` (not innerHTML for security).
       - Click handler: extract videoId from URL via `new URL(window.location.href).searchParams.get('v')`, call `sendMessage('getTranscript', { videoId })`, log the response to console. This verifies the message-passing round trip (Phase 8 success criterion #4).
       - `resetButton()` export: resets any visual state on the button (for SPA navigation). In Phase 8, this is a no-op or just re-detects the theme.
       - Guard against duplicate injection: check if `document.querySelector('transcriptgrab-button')` already exists before creating a new UI. Return the existing UI if found.

    4. **Create `entrypoints/youtube.content/index.ts`:**
       ```typescript
       import { ContentScriptContext } from 'wxt/client';
       import { sendMessage } from '@/utils/messaging';
       import { injectButton, resetButton } from './button';
       ```

       Implementation:
       - `defineContentScript({ matches: ['*://*.youtube.com/*'], runAt: 'document_idle', cssInjectionMode: 'ui' })`
       - In `main(ctx)`:
         - Create a `MatchPattern` for `'*://*.youtube.com/watch*'` to filter /watch pages only (per user decision: standard /watch pages only, no Shorts)
         - Define `handleNavigation(url: string)` async function:
           - If URL does not match watch pattern, return (button only on video pages)
           - Call `injectButton(ctx)` (which guards against duplicates)
           - Call `resetButton()` to reset state for the new video
           - Call `sendMessage('checkAuth', undefined)` to trigger auth badge update (auth rechecked on each navigation per user decision)
         - On initial load: `handleNavigation(window.location.href)`
         - Listen for SPA navigation: `ctx.addEventListener(window, 'wxt:locationchange', ({ newUrl }) => handleNavigation(newUrl.toString()))`
       - No error thrown if user is not signed in (AUTH-05: works without sign-in)
  </action>
  <verify>
    Run from `extension/` directory:
    ```bash
    npx wxt build
    ```
    Build completes without errors. Check that `.output/chrome-mv3/` contains a content script bundle for youtube.content and the style.css is included. Verify the generated manifest.json includes a `content_scripts` entry matching `*://*.youtube.com/*`.
  </verify>
  <done>
    - Content script targets `*://*.youtube.com/*` with `runAt: document_idle`
    - Button injected into `#top-level-buttons-computed` via Shadow DOM (createShadowRootUi)
    - Button styled as YouTube-native pill shape with Lucide file-text icon and "Transcript" label
    - Button adapts to YouTube dark/light theme
    - SPA navigation handled via `wxt:locationchange` event
    - Button persists across navigation without flicker (persist-and-update pattern)
    - Button only appears on /watch pages (not home, search, Shorts)
    - Click triggers `sendMessage('getTranscript', { videoId })` round trip
    - Auth state rechecked on each navigation
    - No errors when user is not signed into transcriptgrab.com
    - Guard against duplicate button injection
  </done>
</task>

<task type="auto">
  <name>Task 2: Toolbar popup with auth status display and web app link</name>
  <files>
    extension/entrypoints/popup/index.html
    extension/entrypoints/popup/main.ts
    extension/entrypoints/popup/style.css
  </files>
  <action>
    Create the extension toolbar popup that shows signed-in status, version info, and a link to transcriptgrab.com. Per user decision: popup matches web app dark theme styling, signed-out users see "Not connected" neutral text, signed-in users see confirmation of connected state.

    1. **Create `entrypoints/popup/index.html`:**
       Standard HTML5 boilerplate. Body has class `dark` for dark theme default.
       Structure:
       - `<div id="popup">` container
       - `<h1>` with "TranscriptGrab" title
       - `<div id="status">` with `<span id="status-dot">` (colored dot) and `<span id="status-text">` ("Checking...")
       - `<p id="version">` for version display
       - `<a id="open-link">` with "Open TranscriptGrab" text (per discretion: include link to web app)
       - Link stylesheet and module script

    2. **Create `entrypoints/popup/style.css`:**
       Style the popup to match the web app's dark theme:
       - Body: `background: #1a1a1a` (oklch(0.145 0 0) approximated to hex), `color: #f5f5f5` (oklch(0.985 0 0))
       - Width: 280px, padding: 16px
       - Font: system-ui or -apple-system, matching web app
       - h1: 16px, bold, margin-bottom 12px
       - Status row: flex layout with dot (8px circle, border-radius 50%) + text
       - Status dot colors: `#22c55e` (green) for connected, `#9ca3af` (gray) for not connected
       - Version: 12px, muted color (#888)
       - Open link: 13px, styled as subtle link, `#60a5fa` (blue-400), no underline, hover underline
       - All sizes in px

    3. **Create `entrypoints/popup/main.ts`:**
       ```typescript
       import { sendMessage } from '@/utils/messaging';
       import { PROD_URL } from '@/utils/constants';
       ```

       Implementation:
       - On DOMContentLoaded:
         - Get DOM refs: `status-dot`, `status-text`, `version`, `open-link`
         - Set version from `chrome.runtime.getManifest().version`
         - Call `sendMessage('checkAuth', undefined)` to check auth state
         - On response: if `isSignedIn`, set dot to green + text "Connected to TranscriptGrab"; if not, set dot to gray + text "Not connected"
         - Wrap in try/catch: on error, show "Not connected" (fail gracefully per AUTH-05)
         - Set `open-link` href to PROD_URL, add click handler that calls `chrome.tabs.create({ url: PROD_URL })` and `window.close()` (opens web app in new tab)
  </action>
  <verify>
    Run from `extension/` directory:
    ```bash
    npx wxt build
    ```
    Build completes without errors. Check that `.output/chrome-mv3/` contains the popup HTML and its bundled JS/CSS. Verify the generated manifest.json includes `"action": { "default_popup": ... }`.
  </verify>
  <done>
    - Popup HTML renders with TranscriptGrab title, status indicator, version, and web app link
    - Popup checks auth state via sendMessage('checkAuth') on open
    - Connected state shows green dot + "Connected to TranscriptGrab"
    - Disconnected state shows gray dot + "Not connected"
    - Version displayed from manifest
    - "Open TranscriptGrab" link opens web app in new tab
    - Dark theme styling matches web app colors
    - Graceful error handling if auth check fails
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify extension loads and functions on YouTube</name>
  <files>extension/.output/chrome-mv3/</files>
  <action>
    Human verification checkpoint. Build the extension and load it in Chrome for manual testing.

    Run `cd extension && npx wxt build` to produce the output bundle, then load it unpacked in Chrome.
  </action>
  <verify>
    1. **Load extension in Chrome:**
       - Open `chrome://extensions/`
       - Enable "Developer mode" (top right)
       - Click "Load unpacked" and select `extension/.output/chrome-mv3/`
       - Extension should appear without errors

    2. **Check toolbar badge:**
       - If signed into transcriptgrab.com: toolbar icon should show green badge dot
       - If NOT signed into transcriptgrab.com: toolbar icon should show gray badge dot

    3. **Check popup:**
       - Click the TranscriptGrab extension icon in the toolbar
       - Should see "TranscriptGrab" title, status (Connected/Not connected), version, and "Open TranscriptGrab" link
       - Click "Open TranscriptGrab" -- should open transcriptgrab.com in a new tab

    4. **Check button injection:**
       - Navigate to any YouTube video (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)
       - A "Transcript" button should appear in the actions row below the video (alongside Like, Share, Download)
       - Button should look like a native YouTube button (pill-shaped, matching theme)

    5. **Check SPA navigation:**
       - Click on another video from the sidebar or recommendations
       - The Transcript button should persist without flashing/disappearing
       - Navigate to YouTube homepage -- button should NOT appear there
       - Navigate back to a video -- button should reappear

    6. **Check message-passing round trip:**
       - Open Chrome DevTools (F12) on a YouTube video page
       - Click the Transcript button
       - Check the console for a log message like: "[TranscriptGrab] getTranscript called for: {videoId}"
       - This confirms the content script -> background -> content script round trip

    7. **Check without auth:**
       - If signed into transcriptgrab.com, sign out
       - Refresh the YouTube page
       - Button should still appear and function (click should still log to console)
       - Toolbar badge should be gray
       - No errors in the extension's service worker console (check via chrome://extensions -> "Inspect views: service worker")
  </verify>
  <done>Type "approved" if all checks pass, or describe any issues found</done>
</task>

</tasks>

<verification>
1. `cd extension && npx wxt build` completes without errors
2. Extension loads in Chrome via "Load unpacked" without errors
3. Transcript button appears on YouTube /watch pages in the actions row
4. Button styled to match YouTube's native pill-shaped buttons, adapts to dark/light theme
5. Button persists across SPA navigation without flicker
6. Button does NOT appear on YouTube homepage, search, or Shorts
7. Clicking button triggers message-passing round trip (visible in console)
8. Toolbar badge shows green when signed into transcriptgrab.com, gray when not
9. Popup shows correct auth status, version, and "Open TranscriptGrab" link
10. Extension functions without errors when not signed into transcriptgrab.com
</verification>

<success_criteria>
All 5 Phase 8 success criteria from ROADMAP.md are met:
1. User can install the extension from local dev build and see a transcript button on any YouTube video page
2. Button persists when user navigates between videos without a full page reload (SPA navigation)
3. Extension shows signed-in indicator when user is logged into transcriptgrab.com, and no indicator when logged out
4. Clicking the button triggers a message-passing round trip to the background service worker and back (verified via console or placeholder response)
5. Extension loads and functions without errors when user is not signed into transcriptgrab.com
</success_criteria>

<output>
After completion, create `.planning/phases/08-extension-foundation/08-02-SUMMARY.md`
</output>
