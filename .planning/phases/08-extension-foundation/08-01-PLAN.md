---
phase: 08-extension-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension/package.json
  - extension/tsconfig.json
  - extension/wxt.config.ts
  - extension/utils/messaging.ts
  - extension/utils/constants.ts
  - extension/entrypoints/background/index.ts
  - extension/entrypoints/background/auth.ts
  - extension/assets/icon-16.png
  - extension/assets/icon-32.png
  - extension/assets/icon-48.png
  - extension/assets/icon-128.png
autonomous: true
requirements: [EXT-01, EXT-04, AUTH-01, AUTH-03]

must_haves:
  truths:
    - "Extension project scaffolds and builds without errors via `npm run dev` in extension/"
    - "Background service worker registers and responds to messages"
    - "Auth detection checks for NextAuth session cookie on transcriptgrab.com (both dev and prod cookie names)"
    - "Toolbar badge updates to green when signed in and gray when not signed in"
  artifacts:
    - path: "extension/wxt.config.ts"
      provides: "WXT configuration with MV3 manifest, permissions, host_permissions"
      contains: "defineConfig"
    - path: "extension/utils/messaging.ts"
      provides: "Type-safe ProtocolMap and messaging exports"
      contains: "defineExtensionMessaging"
    - path: "extension/utils/constants.ts"
      provides: "Shared constants for cookie names, URLs"
      contains: "COOKIE_NAME"
    - path: "extension/entrypoints/background/index.ts"
      provides: "Background service worker with message handlers and cookie change listener"
      contains: "defineBackground"
    - path: "extension/entrypoints/background/auth.ts"
      provides: "Auth state detection and badge update logic"
      exports: ["checkAuthState", "updateAuthBadge"]
  key_links:
    - from: "extension/entrypoints/background/index.ts"
      to: "extension/utils/messaging.ts"
      via: "onMessage import"
      pattern: "import.*onMessage.*from.*messaging"
    - from: "extension/entrypoints/background/index.ts"
      to: "extension/entrypoints/background/auth.ts"
      via: "checkAuthState import"
      pattern: "import.*checkAuthState.*from.*auth"
    - from: "extension/entrypoints/background/auth.ts"
      to: "chrome.cookies API"
      via: "chrome.cookies.get() calls"
      pattern: "chrome\\.cookies\\.get"
---

<objective>
Scaffold the WXT Chrome extension project, establish the type-safe message-passing architecture between content script and background service worker, and implement auth state detection with toolbar badge indicators.

Purpose: Creates the extension skeleton and core infrastructure that all subsequent Phase 8 plans build on. The background service worker, messaging protocol, and auth detection are foundational to the content script and popup.

Output: A buildable WXT extension in `extension/` with a working background service worker that detects auth state via cookie checks and updates the toolbar badge.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-extension-foundation/08-RESEARCH.md
@auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold WXT project with messaging protocol and constants</name>
  <files>
    extension/package.json
    extension/tsconfig.json
    extension/wxt.config.ts
    extension/utils/messaging.ts
    extension/utils/constants.ts
    extension/assets/icon-16.png
    extension/assets/icon-32.png
    extension/assets/icon-48.png
    extension/assets/icon-128.png
  </files>
  <action>
    Initialize the WXT extension project in the `extension/` directory at the project root. This is a standalone project -- not a monorepo workspace, no shared build tooling with the Next.js app.

    1. **Scaffold WXT project:**
       ```bash
       cd /Users/jakesimpson/Projects/transcriptgrab
       mkdir -p extension
       cd extension
       npx wxt@latest init . --template vanilla
       ```
       If the init command prompts or fails due to existing directory, manually create the required files.

    2. **Install dependencies:**
       ```bash
       npm install @webext-core/messaging
       ```

    3. **Configure `wxt.config.ts`:**
       ```typescript
       import { defineConfig } from 'wxt';

       export default defineConfig({
         manifest: {
           name: 'TranscriptGrab',
           description: 'Grab YouTube transcripts instantly',
           permissions: ['cookies', 'storage'],
           host_permissions: [
             'https://transcriptgrab.com/*',
             'http://localhost:3000/*',
           ],
           action: {
             default_title: 'TranscriptGrab',
           },
         },
       });
       ```
       The `cookies` permission is required for `chrome.cookies.get()` to read httpOnly NextAuth session cookies. The `host_permissions` grant cookie access and future API fetch capability for transcriptgrab.com. `storage` is for future use in Phase 9+.

    4. **Create `utils/messaging.ts`** with the shared ProtocolMap:
       ```typescript
       import { defineExtensionMessaging } from '@webext-core/messaging';

       interface ProtocolMap {
         getTranscript(data: { videoId: string; languageCode?: string }): {
           success: boolean;
           message?: string;
         };
         checkAuth(): { isSignedIn: boolean };
       }

       export const { sendMessage, onMessage } = defineExtensionMessaging<ProtocolMap>();
       ```
       The `getTranscript` handler returns a placeholder response for now. Phase 9 will implement the real transcript fetch. `checkAuth` is fully functional in this plan.

    5. **Create `utils/constants.ts`:**
       ```typescript
       export const COOKIE_NAME = 'authjs.session-token';
       export const SECURE_COOKIE_NAME = '__Secure-authjs.session-token';
       export const PROD_URL = 'https://transcriptgrab.com';
       export const DEV_URL = 'http://localhost:3000';
       export const ANCHOR_SELECTOR = '#top-level-buttons-computed';
       export const FALLBACK_ANCHOR_SELECTOR = 'ytd-menu-renderer';
       ```
       Two cookie names because NextAuth v5 uses `__Secure-` prefix on HTTPS (production) and unprefixed on HTTP (development).

    6. **Generate placeholder extension icons:**
       Create simple PNG icons at 16x16, 32x32, 48x48, and 128x128 in `extension/assets/`. Use a simple approach: create them with a tool or generate basic colored squares via canvas/sharp. These are development placeholders -- real icons come later. If no image generation tool is available, create minimal valid PNG files or use a solid-color SVG converted to PNG. The simplest approach: download a free document/transcript icon from a CDN, or create the PNGs programmatically using Node.js canvas.

    Verify `tsconfig.json` includes path alias `@/` pointing to the project root so imports like `@/utils/messaging` work (WXT should configure this by default).
  </action>
  <verify>
    Run from `extension/` directory:
    ```bash
    npx wxt build
    ```
    Build should complete without errors. Check that `.output/chrome-mv3/manifest.json` contains the correct permissions, host_permissions, and background service worker entry.
  </verify>
  <done>
    - `extension/` directory exists as a standalone WXT project with its own `package.json`
    - `wxt.config.ts` configures MV3 manifest with `cookies`, `storage` permissions and `host_permissions` for transcriptgrab.com
    - `utils/messaging.ts` exports typed `sendMessage` and `onMessage` with `getTranscript` and `checkAuth` protocol
    - `utils/constants.ts` exports cookie names, URLs, and DOM selectors
    - Extension icon PNGs exist at all 4 sizes
    - Project builds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement background service worker with auth detection and badge updates</name>
  <files>
    extension/entrypoints/background/index.ts
    extension/entrypoints/background/auth.ts
  </files>
  <action>
    Create the background service worker that handles message passing, auth state detection via cookie checks, and toolbar badge updates.

    1. **Create `entrypoints/background/auth.ts`:**
       ```typescript
       import { COOKIE_NAME, SECURE_COOKIE_NAME, PROD_URL, DEV_URL } from '@/utils/constants';

       export async function checkAuthState(): Promise<boolean> {
         try {
           // Try production (HTTPS) cookie first
           const secureCookie = await chrome.cookies.get({
             url: PROD_URL,
             name: SECURE_COOKIE_NAME,
           });
           if (secureCookie) return true;

           // Try development (HTTP) cookie
           const devCookie = await chrome.cookies.get({
             url: DEV_URL,
             name: COOKIE_NAME,
           });
           return !!devCookie;
         } catch {
           return false;
         }
       }

       export async function updateAuthBadge(isSignedIn: boolean): Promise<void> {
         if (isSignedIn) {
           await chrome.action.setBadgeText({ text: ' ' });
           await chrome.action.setBadgeBackgroundColor({ color: '#22c55e' }); // green-500
         } else {
           await chrome.action.setBadgeText({ text: ' ' });
           await chrome.action.setBadgeBackgroundColor({ color: '#9ca3af' }); // gray-400
         }
       }
       ```
       The space character for badge text creates a visible colored dot without displaying text. Green (#22c55e) for signed in, gray (#9ca3af) for not signed in -- per user decision.

    2. **Create `entrypoints/background/index.ts`:**
       ```typescript
       import { onMessage } from '@/utils/messaging';
       import { checkAuthState, updateAuthBadge } from './auth';

       export default defineBackground(() => {
         // Handle auth check requests from content script
         onMessage('checkAuth', async () => {
           const isSignedIn = await checkAuthState();
           await updateAuthBadge(isSignedIn);
           return { isSignedIn };
         });

         // Handle transcript fetch requests (placeholder -- Phase 9 implements real fetch)
         onMessage('getTranscript', async ({ data }) => {
           console.log('[TranscriptGrab] getTranscript called for:', data.videoId);
           return {
             success: true,
             message: `Transcript fetch placeholder for video ${data.videoId}`,
           };
         });

         // Listen for cookie changes to update auth state reactively
         chrome.cookies.onChanged.addListener(async (changeInfo) => {
           if (
             changeInfo.cookie.domain.includes('transcriptgrab.com') &&
             changeInfo.cookie.name.includes('session-token')
           ) {
             const isSignedIn = await checkAuthState();
             await updateAuthBadge(isSignedIn);
           }
         });

         // Check auth state on service worker startup
         checkAuthState().then(updateAuthBadge);
       });
       ```
       The `defineBackground` is auto-imported by WXT. The cookie change listener provides reactive badge updates when the user signs in/out on transcriptgrab.com. The getTranscript handler logs and returns a placeholder to verify the message-passing round trip works (Phase 8 success criterion #4).
  </action>
  <verify>
    Run from `extension/` directory:
    ```bash
    npx wxt build
    ```
    Build should complete without errors. Verify `.output/chrome-mv3/background.js` exists (or equivalent service worker bundle). Verify the generated manifest.json includes `"background": { "service_worker": ... }`.
  </verify>
  <done>
    - Background service worker registers via `defineBackground`
    - `checkAuth` message handler checks both `__Secure-authjs.session-token` (prod) and `authjs.session-token` (dev) cookies
    - `getTranscript` message handler returns placeholder response with video ID
    - Cookie change listener reactively updates badge when user signs in/out on transcriptgrab.com
    - Badge shows green (#22c55e) when signed in, gray (#9ca3af) when not
    - Auth state checked on service worker startup
    - Extension builds without errors
  </done>
</task>

</tasks>

<verification>
1. `cd extension && npx wxt build` completes without errors
2. `.output/chrome-mv3/manifest.json` contains:
   - `"manifest_version": 3`
   - `"permissions": ["cookies", "storage"]`
   - `"host_permissions"` includes `"https://transcriptgrab.com/*"`
   - `"background"` with `"service_worker"` entry
3. `utils/messaging.ts` exports `sendMessage` and `onMessage` with typed ProtocolMap
4. `entrypoints/background/auth.ts` exports `checkAuthState` and `updateAuthBadge`
5. Background service worker handles `checkAuth` and `getTranscript` messages
</verification>

<success_criteria>
- WXT project in `extension/` builds to a valid MV3 Chrome extension
- Message protocol defines `checkAuth` and `getTranscript` with TypeScript types
- Background service worker detects auth state via cookie check (both dev and prod cookie names)
- Toolbar badge color updates based on auth state (green = signed in, gray = not)
- Cookie change listener provides reactive auth state updates
</success_criteria>

<output>
After completion, create `.planning/phases/08-extension-foundation/08-01-SUMMARY.md`
</output>
