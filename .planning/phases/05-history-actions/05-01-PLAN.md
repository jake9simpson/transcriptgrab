---
phase: 05-history-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/queries.ts
  - app/api/transcript/delete/route.ts
  - components/ui/alert-dialog.tsx
  - components/HistoryCard.tsx
  - app/history/[id]/page.tsx
autonomous: true
requirements:
  - HIST-05
  - HIST-06
  - UIUX-04

must_haves:
  truths:
    - "User can click a copy button on a history card and get the full transcript text on their clipboard"
    - "Copy action triggers a toast notification confirming the copy"
    - "User can click a delete button on a history card and sees a confirmation dialog"
    - "Confirming delete removes the transcript from the database and refreshes the list"
    - "User can copy and delete transcripts from the detail page as well"
  artifacts:
    - path: "app/api/transcript/delete/route.ts"
      provides: "Auth-protected delete endpoint accepting { ids: string[] }"
      exports: ["POST"]
    - path: "lib/db/queries.ts"
      provides: "deleteTranscripts batch delete function"
      contains: "deleteTranscripts"
    - path: "components/ui/alert-dialog.tsx"
      provides: "shadcn AlertDialog component for delete confirmation"
    - path: "components/HistoryCard.tsx"
      provides: "Copy and delete buttons on each history card"
      contains: "handleCopy"
    - path: "app/history/[id]/page.tsx"
      provides: "Copy and delete actions on transcript detail page"
  key_links:
    - from: "components/HistoryCard.tsx"
      to: "/api/transcript/delete"
      via: "fetch POST in handleDelete"
      pattern: "fetch.*api/transcript/delete"
    - from: "app/api/transcript/delete/route.ts"
      to: "lib/db/queries.ts"
      via: "deleteTranscripts function call"
      pattern: "deleteTranscripts"
    - from: "components/HistoryCard.tsx"
      to: "navigator.clipboard"
      via: "handleCopy writes formatted text"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Add copy and delete actions to individual transcripts in history. Users can one-click copy any transcript's full text from the history list or detail page, with toast feedback. Users can delete individual transcripts with a confirmation dialog.

Purpose: HIST-05 (copy from history), HIST-06 (delete individual), UIUX-04 (copy visual feedback)
Output: Delete API endpoint, updated HistoryCard with action buttons, updated detail page with actions
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-actions/05-RESEARCH.md

@lib/db/queries.ts
@lib/db/schema.ts
@app/api/transcript/save/route.ts
@components/HistoryCard.tsx
@components/ActionButtons.tsx
@app/history/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete API endpoint and query function</name>
  <files>
    lib/db/queries.ts
    app/api/transcript/delete/route.ts
    components/ui/alert-dialog.tsx
  </files>
  <action>
1. Add `deleteTranscripts` function to `lib/db/queries.ts`:
   - Signature: `deleteTranscripts(ids: string[], userId: string): Promise<number>`
   - Import `inArray` from drizzle-orm (add to existing import)
   - Use `db.delete(transcripts).where(and(inArray(transcripts.id, ids), eq(transcripts.userId, userId))).returning({ id: transcripts.id })`
   - Return `rows.length` (count of deleted rows)
   - The `and(inArray, eq)` pattern ensures users can only delete their own transcripts

2. Create `app/api/transcript/delete/route.ts`:
   - Follow the exact same `auth()` wrapper pattern from `app/api/transcript/save/route.ts`
   - Export `POST` (not DELETE method -- matches existing save route pattern and works cleanly with auth wrapper)
   - Parse `{ ids }` from request body
   - Validate: `Array.isArray(ids) && ids.length > 0`, return 400 if invalid
   - Call `deleteTranscripts(ids, req.auth.user.id)`
   - Return `{ deleted: count }`
   - Wrap in try/catch, return 500 on error

3. Install shadcn alert-dialog component:
   - Run `npx shadcn@latest add alert-dialog --yes`
   - This creates `components/ui/alert-dialog.tsx`
  </action>
  <verify>
    - `grep "deleteTranscripts" lib/db/queries.ts` shows the new function
    - `grep "inArray" lib/db/queries.ts` shows the import
    - `ls app/api/transcript/delete/route.ts` confirms file exists
    - `ls components/ui/alert-dialog.tsx` confirms shadcn component installed
    - `npm run build` passes (type check)
  </verify>
  <done>Delete endpoint at POST /api/transcript/delete accepts { ids: string[] }, deletes only user-owned transcripts, returns { deleted: number }. Alert dialog component available for use.</done>
</task>

<task type="auto">
  <name>Task 2: Copy and delete buttons on HistoryCard and detail page</name>
  <files>
    components/HistoryCard.tsx
    app/history/[id]/page.tsx
  </files>
  <action>
1. Update `components/HistoryCard.tsx`:
   - Add imports: `useRouter` from `next/navigation`, `toast` from `sonner`, `formatTranscriptText` from `@/lib/format`, `Button` from `@/components/ui/button`, `Copy`, `Trash2`, `Check` from `lucide-react`, and all AlertDialog parts from `@/components/ui/alert-dialog`
   - Add `useState` for `copied` (boolean, default false) and `deleting` (boolean, default false)
   - Add `useRouter()` hook
   - Add `handleCopy` function:
     - Call `e.stopPropagation()` and `e.preventDefault()` to prevent Link navigation
     - `const text = formatTranscriptText(transcript.segments, false)` (plain text, no timestamps)
     - `navigator.clipboard.writeText(text).then(() => { toast("Copied to clipboard"); setCopied(true); setTimeout(() => setCopied(false), 2000); })`
   - Add `handleDelete` async function:
     - Set `deleting` to true
     - `fetch("/api/transcript/delete", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ ids: [transcript.id] }) })`
     - On success: `toast("Transcript deleted")`, `router.refresh()`
     - On error: `toast("Failed to delete transcript")`
     - Set `deleting` to false in finally block
   - Restructure the card layout: keep the existing `<Link>` wrapper but add a button row at the bottom-right of the card content area (inside the text column `div`). Buttons must call `e.stopPropagation()` and `e.preventDefault()` on their `onClick` to prevent the Link from navigating.
   - Copy button: `<Button variant="ghost" size="icon" onClick={handleCopy}>` with Copy/Check icon swap based on `copied` state
   - Delete button: wrap in AlertDialog. The AlertDialogTrigger should be a `<Button variant="ghost" size="icon" onClick={(e) => e.stopPropagation()}>` with Trash2 icon. AlertDialogContent contains title "Delete transcript?", description "This will permanently remove this transcript from your history. This action cannot be undone.", Cancel button, and Delete action button that calls handleDelete. The AlertDialogContent needs `onClick={(e) => e.stopPropagation()}` to prevent clicks inside the dialog from propagating to the Link.
   - Button row: `<div className="mt-2 flex items-center gap-1">` containing the copy button and the alert dialog trigger

2. Update `app/history/[id]/page.tsx` to add copy and delete:
   - This is a server component, so create a small client component inline or extract one. The simplest approach: create a `TranscriptDetailActions` client component directly in the same file or as a separate section.
   - Actually, since the detail page is a server component and needs client interactivity, add a new client component section. The cleanest approach: extract a `DetailActions` client component at the top of the file (with "use client" in its own module) -- but to keep files_modified minimal, add it inline using a pattern.
   - Better approach: Create the actions as part of the page by importing components. Add a client component `components/TranscriptDetailActions.tsx` -- wait, that adds a file. Instead, refactor the detail page to import the needed pieces:
   - Simplest: Make the detail page import a new small client component. But to stay within files_modified, add the action buttons directly into the detail page by making it a client component? No, it uses `auth()` which is server-only.
   - Best approach: Add `components/TranscriptDetailActions.tsx` as a lightweight client component (add to files list). It accepts `transcriptId: string` and `segments: TranscriptSegment[]`, renders copy + delete buttons with alert dialog, and on delete navigates to `/history` via `router.push("/history")`.
   - In the detail page, import `TranscriptDetailActions` and render it between the video metadata section and the TranscriptViewer, passing `transcript.id` and `segments`.

Note on event propagation: The HistoryCard wraps everything in a `<Link>`. Clicking buttons inside would navigate. Every button onClick must call `e.stopPropagation()` and `e.preventDefault()`. The AlertDialog portal renders outside the Link DOM, so the dialog content itself is safe, but the trigger button still needs propagation stopped.
  </action>
  <verify>
    - `npm run build` passes
    - HistoryCard renders copy and delete icon buttons
    - Detail page renders copy and delete buttons
    - `grep "stopPropagation" components/HistoryCard.tsx` confirms event handling
    - `grep "router.refresh" components/HistoryCard.tsx` confirms post-delete refresh
  </verify>
  <done>Each history card has copy (with toast feedback) and delete (with AlertDialog confirmation) buttons. Detail page has copy and delete buttons. Copy writes plain text to clipboard with "Copied to clipboard" toast. Delete calls the API, shows confirmation dialog first, refreshes the list after success. Detail page delete redirects to /history.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no type errors
- HistoryCard shows copy and delete icon buttons that do not trigger Link navigation
- Clicking copy on a card writes transcript text to clipboard and shows toast
- Clicking delete on a card shows AlertDialog, confirming deletes and refreshes list
- Detail page shows copy and delete buttons
- Delete on detail page removes transcript and redirects to /history
- Delete API returns 401 for unauthenticated requests
- Delete API returns 400 for missing/empty ids array
</verification>

<success_criteria>
Users can copy transcript text from any history card or detail page with one click and see a toast confirmation. Users can delete individual transcripts with a confirmation dialog that warns the action is permanent. Deleted transcripts are removed from the database and the UI refreshes immediately.
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-actions/05-01-SUMMARY.md`
</output>
