---
phase: 05-history-actions
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - components/ui/checkbox.tsx
  - components/HistoryActions.tsx
  - app/history/page.tsx
autonomous: true
requirements:
  - HIST-07

must_haves:
  truths:
    - "User can enter selection mode to see checkboxes on history cards"
    - "User can select individual transcripts via checkboxes"
    - "User can select all or deselect all transcripts at once"
    - "User can delete all selected transcripts in one action with confirmation"
    - "Selection state clears after bulk delete completes"
  artifacts:
    - path: "components/ui/checkbox.tsx"
      provides: "shadcn Checkbox component"
    - path: "components/HistoryActions.tsx"
      provides: "Client wrapper managing selection state, bulk toolbar, and card rendering"
      contains: "selectionMode"
    - path: "app/history/page.tsx"
      provides: "Server component delegates card rendering to HistoryActions client wrapper"
  key_links:
    - from: "components/HistoryActions.tsx"
      to: "/api/transcript/delete"
      via: "fetch POST with multiple IDs for bulk delete"
      pattern: "fetch.*api/transcript/delete.*ids"
    - from: "app/history/page.tsx"
      to: "components/HistoryActions.tsx"
      via: "passes transcripts array as prop"
      pattern: "HistoryActions.*transcripts"
    - from: "components/HistoryActions.tsx"
      to: "components/HistoryCard.tsx"
      via: "renders HistoryCard with selection props"
      pattern: "HistoryCard"
---

<objective>
Add bulk-select and bulk-delete capabilities to the history list. Users can toggle selection mode, check individual transcripts or select all, and delete the entire selection in one action with confirmation.

Purpose: HIST-07 (bulk-select and delete multiple transcripts)
Output: HistoryActions client wrapper, checkbox component, updated history page
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-actions/05-RESEARCH.md
@.planning/phases/05-history-actions/05-01-SUMMARY.md

@components/HistoryCard.tsx
@app/history/page.tsx
@lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install checkbox and create HistoryActions wrapper</name>
  <files>
    components/ui/checkbox.tsx
    components/HistoryActions.tsx
  </files>
  <action>
1. Install shadcn checkbox:
   - Run `npx shadcn@latest add checkbox --yes`
   - Creates `components/ui/checkbox.tsx`

2. Create `components/HistoryActions.tsx` (client component):
   - `"use client"` directive
   - Props interface: `{ transcripts: HistoryTranscript[] }` where HistoryTranscript matches the same interface used by HistoryCard (id, videoId, videoUrl, videoTitle, thumbnailUrl, videoDuration, segments, savedAt). Export this interface from the file or import from a shared location. Since HistoryCard defines it locally, the cleanest approach: define the interface in HistoryActions and also update HistoryCard to import it. OR simply duplicate the interface (small, stable). Prefer: define in HistoryActions and have HistoryCard import from there.
   - State: `selectionMode: boolean` (default false), `selected: Set<string>` (default empty), `deleting: boolean` (default false)
   - Import `useRouter`, `useState` from appropriate packages
   - Import `toast` from `sonner`, `Button` from ui, `Checkbox` from ui, `AlertDialog` parts from ui
   - Import `Trash2`, `CheckSquare`, `X` from `lucide-react`
   - Import `HistoryCard` from `@/components/HistoryCard`

   **Selection mode toggle:**
   - A "Select" button in the toolbar that toggles `selectionMode`
   - When entering selection mode, show "Cancel" button instead
   - When exiting selection mode, clear `selected` set

   **Toolbar (visible when selectionMode is true):**
   - Render above the card list
   - "Select All" button: adds all transcript IDs to `selected`
   - "Deselect All" button: clears `selected` (show only when some are selected)
   - Selection count: "{N} selected" text
   - "Delete Selected" button (destructive variant): wrapped in AlertDialog
     - AlertDialog title: "Delete {N} transcripts?"
     - AlertDialog description: "This will permanently remove {N} transcripts from your history. This action cannot be undone."
     - On confirm: call handleBulkDelete

   **handleBulkDelete:**
   - Set `deleting` to true
   - `fetch("/api/transcript/delete", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ ids: Array.from(selected) }) })`
   - On success: `toast(\`Deleted ${selected.size} transcripts\`)`, clear selected, set selectionMode to false, `router.refresh()`
   - On error: `toast("Failed to delete transcripts")`
   - Set `deleting` to false in finally block

   **Card rendering:**
   - Map over transcripts and render each HistoryCard
   - When in selection mode, render a Checkbox to the left of each card
   - The checkbox + card should be in a flex row: `<div className="flex items-start gap-3">`
   - Checkbox: `<Checkbox checked={selected.has(t.id)} onCheckedChange={(checked) => toggle(t.id, checked)}>`
   - The toggle function: if checked, add to set; if unchecked, remove from set
   - HistoryCard is rendered normally beside the checkbox

   **Update HistoryCard interface:**
   - The HistoryCard currently defines `HistoryTranscript` locally. To share it, export the interface from HistoryCard.tsx (add `export` to the interface declaration). Then import it in HistoryActions.tsx. This is the minimal change.
  </action>
  <verify>
    - `ls components/ui/checkbox.tsx` confirms shadcn component installed
    - `ls components/HistoryActions.tsx` confirms wrapper exists
    - `grep "selectionMode" components/HistoryActions.tsx` shows selection state
    - `grep "handleBulkDelete" components/HistoryActions.tsx` shows bulk delete handler
    - `grep "export interface HistoryTranscript" components/HistoryCard.tsx` shows exported type
    - `npm run build` passes
  </verify>
  <done>HistoryActions client wrapper manages selection mode with checkboxes, select all/deselect all, and bulk delete with confirmation dialog. Checkbox shadcn component installed. HistoryTranscript interface shared between HistoryCard and HistoryActions.</done>
</task>

<task type="auto">
  <name>Task 2: Wire HistoryActions into history page</name>
  <files>
    app/history/page.tsx
  </files>
  <action>
1. Update `app/history/page.tsx`:
   - Import `HistoryActions` from `@/components/HistoryActions`
   - Replace the existing card list rendering block. Currently:
     ```
     <div className="flex flex-col gap-3">
       {transcripts.map((t) => (
         <HistoryCard key={t.id} transcript={t} />
       ))}
     </div>
     ```
   - Replace with:
     ```
     <HistoryActions transcripts={transcripts} />
     ```
   - Keep the empty state rendering as-is (the `transcripts.length === 0` branch stays unchanged)
   - Remove the direct `HistoryCard` import since HistoryActions handles rendering internally
   - The page header (title + count badge) stays as server-rendered content
   - The "Select" button from HistoryActions will appear within that component's own header area, so the page just needs to render `<HistoryActions>` in place of the card list

2. The page remains a server component. Data fetching happens server-side, then the transcript array is passed to the client wrapper. This preserves RSC benefits while enabling client interactivity for selection.
  </action>
  <verify>
    - `npm run build` passes
    - `grep "HistoryActions" app/history/page.tsx` shows the new import and usage
    - `grep -c "HistoryCard" app/history/page.tsx` returns 0 (direct HistoryCard import removed)
    - History page renders the HistoryActions wrapper which internally renders HistoryCards with optional checkboxes
  </verify>
  <done>History page delegates card rendering to HistoryActions client wrapper. Selection mode toggle, checkboxes, select all/deselect all, and bulk delete all functional from the history list page. Server-side data fetching preserved.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no type errors
- History page shows a "Select" button
- Clicking "Select" enters selection mode, showing checkboxes on each card
- Checking individual cards adds them to selection
- "Select All" checks all cards; "Deselect All" unchecks all
- "Delete Selected" shows AlertDialog with count, confirming deletes all selected
- After bulk delete, selection clears, selection mode exits, list refreshes
- "Cancel" exits selection mode without deleting
- Works correctly with 1, many, and all transcripts selected
</verification>

<success_criteria>
Users can enter selection mode, check any combination of transcripts (individually or via select all), and delete the entire selection with one confirmation dialog. The bulk delete hits the same API endpoint with multiple IDs. After deletion, the UI refreshes and selection state resets cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-actions/05-02-SUMMARY.md`
</output>
