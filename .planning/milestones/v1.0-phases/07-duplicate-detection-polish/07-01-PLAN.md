---
phase: 07-duplicate-detection-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/queries.ts
  - app/api/transcript/check/route.ts
  - components/DuplicateWarning.tsx
  - components/SaveTranscript.tsx
autonomous: true
requirements:
  - PERS-04

must_haves:
  truths:
    - "User sees inline warning when generating a transcript for an already-saved video"
    - "Warning appears before the auto-save fires (pre-check, not post-save)"
    - "Warning includes a link to view the existing saved transcript"
    - "Auto-save is suppressed when a duplicate is detected"
    - "Unauthenticated users see no warnings and transcript generation works unchanged"
    - "If the pre-check fails, auto-save proceeds normally (fail-open)"
    - "Database-level onConflictDoNothing remains as safety net"
  artifacts:
    - path: "lib/db/queries.ts"
      provides: "getTranscriptByVideoId query"
      contains: "getTranscriptByVideoId"
    - path: "app/api/transcript/check/route.ts"
      provides: "GET endpoint returning { exists, transcriptId }"
      exports: ["GET"]
    - path: "components/DuplicateWarning.tsx"
      provides: "Inline Alert banner with link to saved transcript"
      contains: "DuplicateWarning"
    - path: "components/SaveTranscript.tsx"
      provides: "Pre-check flow before save timer, conditional DuplicateWarning render"
      contains: "duplicateInfo"
  key_links:
    - from: "components/SaveTranscript.tsx"
      to: "/api/transcript/check"
      via: "fetch in useEffect before save timer"
      pattern: "fetch.*api/transcript/check"
    - from: "app/api/transcript/check/route.ts"
      to: "lib/db/queries.ts"
      via: "getTranscriptByVideoId call"
      pattern: "getTranscriptByVideoId"
    - from: "components/SaveTranscript.tsx"
      to: "components/DuplicateWarning.tsx"
      via: "conditional render when duplicateInfo is set"
      pattern: "DuplicateWarning"
---

<objective>
Add proactive duplicate detection so users see a visible warning with a link to their existing saved transcript before the auto-save fires, preventing unnecessary save attempts and giving users direct access to their history.

Purpose: Satisfies PERS-04 -- the last remaining v1 requirement. Elevates duplicate handling from a silent backend no-op to a visible, actionable user experience.
Output: New check query, check API endpoint, DuplicateWarning component, and modified SaveTranscript with pre-check flow.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-duplicate-detection-polish/07-RESEARCH.md
@lib/db/queries.ts
@components/SaveTranscript.tsx
@app/api/transcript/save/route.ts
@components/ui/alert.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add duplicate check query and API endpoint</name>
  <files>lib/db/queries.ts, app/api/transcript/check/route.ts</files>
  <action>
Add a `getTranscriptByVideoId` query to `lib/db/queries.ts`:
- SELECT `id` and `savedAt` from transcripts WHERE `userId` = param AND `videoId` = param, LIMIT 1.
- Use existing `and()`, `eq()` imports (already imported in queries.ts).
- Return `rows[0] ?? null`. Follow the exact same pattern as `getTranscriptById`.

Create `app/api/transcript/check/route.ts`:
- Export a GET handler wrapped with `auth()` from `@/auth` (same pattern as save/route.ts).
- If `!req.auth?.user?.id`, return `NextResponse.json({ exists: false, transcriptId: null })` (not 401 -- fail-open for unauthenticated users).
- Read `videoId` from `new URL(req.url).searchParams.get("videoId")`.
- If no videoId param, return `{ exists: false, transcriptId: null }`.
- Call `getTranscriptByVideoId(req.auth.user.id, videoId)`.
- Return `{ exists: !!existing, transcriptId: existing?.id ?? null }`.
- Wrap the query call in try/catch, return `{ exists: false, transcriptId: null }` on error with status 500.
  </action>
  <verify>
Run `npm run build` to verify the new query and route compile without errors. Verify the route file is detected by checking build output includes `api/transcript/check`.
  </verify>
  <done>
`getTranscriptByVideoId` query exists in queries.ts. GET `/api/transcript/check?videoId=X` returns `{ exists, transcriptId }` for authenticated users and `{ exists: false }` for unauthenticated users.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DuplicateWarning component and wire pre-check into SaveTranscript</name>
  <files>components/DuplicateWarning.tsx, components/SaveTranscript.tsx</files>
  <action>
Create `components/DuplicateWarning.tsx`:
- "use client" directive.
- Import `AlertTriangle` from `lucide-react`, `Alert`, `AlertTitle`, `AlertDescription` from `@/components/ui/alert`, `Button` from `@/components/ui/button`, `Link` from `next/link`.
- Accept prop `transcriptId: string`.
- Render an `Alert` with `AlertTriangle` icon, title "Already in your history", description text "You have already saved a transcript for this video.", and a `Button variant="outline" size="sm" className="mt-2" asChild` wrapping a `Link href={/history/${transcriptId}}` reading "View saved transcript".

Modify `components/SaveTranscript.tsx`:
- Add `useState` import (already has useEffect, useRef).
- Add state: `const [duplicateInfo, setDuplicateInfo] = useState<{ transcriptId: string } | null>(null)`.
- Replace the current `useEffect` logic with a pre-check flow:
  1. Guard on `!session?.user?.id` and `savedRef.current === videoId` (same as current).
  2. Reset `setDuplicateInfo(null)` at the top of the effect (handles video change clearing stale warnings -- Pitfall 5 from research).
  3. Define `let cancelled = false` for cleanup.
  4. Define `async function checkAndSave()`:
     a. First, call `fetch(/api/transcript/check?videoId=${videoId})` in a try/catch.
     b. If response indicates `exists: true`, set `setDuplicateInfo({ transcriptId: checkData.transcriptId })`, set `savedRef.current = videoId`, and return (skip save).
     c. If check fails (catch block) or `cancelled` is true, fall through to save (fail-open).
     d. If no duplicate, wait 2.5s with `setTimeout` wrapped in a Promise (store timeout in timerRef for cleanup).
     e. If not cancelled after timeout, proceed with existing save logic (POST to /api/transcript/save, toast on success).
  5. Call `checkAndSave()`.
  6. Cleanup function: set `cancelled = true`, clear timeout via `timerRef`.
- Add a `timerRef = useRef<ReturnType<typeof setTimeout> | null>(null)` for the save delay timer cleanup.
- Change the return: if `duplicateInfo` is not null, render `<DuplicateWarning transcriptId={duplicateInfo.transcriptId} />`. Otherwise return `null`.
- Keep the dependency array as `[session?.user?.id, videoId]`.

Key behaviors to preserve:
- Unauthenticated users: no check, no save, no warning (guard on session).
- Same video re-render: `savedRef.current === videoId` prevents re-firing.
- The existing `onConflictDoNothing` in the save query remains untouched as the database safety net.
- The "Transcript saved to history" toast still fires for genuinely new saves.
- The post-save "Already in your history" toast path is kept as fallback if the pre-check fails and the save detects a duplicate via `data.inserted === false`.
  </action>
  <verify>
Run `npm run build` to verify all components compile. Check that SaveTranscript still accepts the same props (no interface change). Verify DuplicateWarning renders by checking the build succeeds with the new import.
  </verify>
  <done>
DuplicateWarning shows an inline alert with a link to `/history/{transcriptId}`. SaveTranscript calls the check endpoint before the save timer, shows the warning on duplicate, and suppresses auto-save. Fail-open behavior preserved: if check fails, save proceeds and onConflictDoNothing handles it at the database level. No changes to app/page.tsx needed since SaveTranscript already renders in the correct position.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript or compilation errors.
2. New route `api/transcript/check` appears in the build output.
3. No changes to `app/page.tsx` -- SaveTranscript position unchanged.
4. `lib/db/queries.ts` contains `getTranscriptByVideoId` export.
5. `components/DuplicateWarning.tsx` exists and imports Alert from shadcn.
6. `components/SaveTranscript.tsx` contains pre-check fetch to `/api/transcript/check`, `duplicateInfo` state, and conditional DuplicateWarning render.
7. The existing save endpoint (`/api/transcript/save`) and `onConflictDoNothing` query are untouched.
</verification>

<success_criteria>
- Authenticated user generating a transcript for an already-saved video sees an inline "Already in your history" alert with a "View saved transcript" link, before any save attempt.
- Authenticated user generating a transcript for a new video sees the normal "Transcript saved to history" toast after 2.5s.
- Unauthenticated users experience no change in behavior.
- Build passes cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/07-duplicate-detection-polish/07-01-SUMMARY.md`
</output>
