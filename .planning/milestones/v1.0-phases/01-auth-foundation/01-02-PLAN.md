---
phase: 01-auth-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - components/AuthButton.tsx
  - components/SignInHint.tsx
  - app/layout.tsx
  - app/page.tsx
  - app/history/page.tsx
autonomous: false
requirements:
  - AUTH-02
  - AUTH-04

must_haves:
  truths:
    - "Signed-out user sees 'Sign in' button in the header top-right"
    - "Signed-in user sees their avatar in the header instead of the sign-in button"
    - "Clicking avatar opens dropdown showing name, email, History (disabled), Settings (disabled), and Sign out"
    - "Clicking 'Sign out' in dropdown signs the user out immediately (no confirmation)"
    - "Signed-out user sees subtle 'Sign in to save to history' hint near transcript output"
    - "Signed-in user does not see the sign-in hint"
    - "Visiting /history while signed out redirects to home"
    - "Loading state shows a pulsing skeleton circle while auth status resolves"
  artifacts:
    - path: "components/AuthButton.tsx"
      provides: "Conditional sign-in button or avatar dropdown menu"
      exports: ["default"]
      min_lines: 40
    - path: "components/SignInHint.tsx"
      provides: "Subtle hint for unauthenticated users near transcript output"
      exports: ["default"]
    - path: "app/history/page.tsx"
      provides: "Protected route placeholder for Phase 4"
      contains: "redirect"
    - path: "app/layout.tsx"
      provides: "Header with AuthButton alongside ThemeToggle"
      contains: "AuthButton"
    - path: "app/page.tsx"
      provides: "Main page with SignInHint after transcript output"
      contains: "SignInHint"
  key_links:
    - from: "components/AuthButton.tsx"
      to: "next-auth/react"
      via: "useSession, signIn, signOut hooks"
      pattern: "useSession|signIn|signOut"
    - from: "components/AuthButton.tsx"
      to: "components/ui/avatar.tsx"
      via: "Avatar component for user profile image"
      pattern: "Avatar"
    - from: "components/AuthButton.tsx"
      to: "components/ui/dropdown-menu.tsx"
      via: "DropdownMenu for user actions"
      pattern: "DropdownMenu"
    - from: "app/layout.tsx"
      to: "components/AuthButton.tsx"
      via: "AuthButton rendered in header"
      pattern: "AuthButton"
    - from: "app/page.tsx"
      to: "components/SignInHint.tsx"
      via: "SignInHint rendered after transcript output"
      pattern: "SignInHint"
    - from: "components/SignInHint.tsx"
      to: "next-auth/react"
      via: "useSession to check auth status"
      pattern: "useSession"
    - from: "app/history/page.tsx"
      to: "auth.ts"
      via: "Server-side auth() check with redirect"
      pattern: "auth.*from.*@/auth"
---

<objective>
Build the auth UI layer: conditional sign-in button / avatar dropdown in the header, "sign in to save" hint on the transcript page, and a protected /history placeholder route.

Purpose: Make auth visible and usable to end users. Signed-out users see a sign-in button and a hint. Signed-in users see their avatar with a dropdown for sign-out. This completes the user-facing auth experience for Phase 1.
Output: AuthButton component in header, SignInHint on main page, protected /history route, full auth UI flow working end-to-end.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation/01-RESEARCH.md
@.planning/phases/01-auth-foundation/01-CONTEXT.md
@.planning/phases/01-auth-foundation/01-01-SUMMARY.md
@app/layout.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthButton component and integrate into header</name>
  <files>
    components/AuthButton.tsx
    app/layout.tsx
  </files>
  <action>
    1. Create `components/AuthButton.tsx` as a `"use client"` component:
       - Import `useSession`, `signIn`, `signOut` from `"next-auth/react"`
       - Import `Button` from `"@/components/ui/button"`
       - Import `Avatar`, `AvatarFallback`, `AvatarImage` from `"@/components/ui/avatar"`
       - Import `DropdownMenu`, `DropdownMenuContent`, `DropdownMenuItem`, `DropdownMenuLabel`, `DropdownMenuSeparator`, `DropdownMenuTrigger` from `"@/components/ui/dropdown-menu"`

       Three states based on `useSession()`:
       a) **Loading** (`status === "loading"`): Render a `div` with `className="h-8 w-8 animate-pulse rounded-full bg-muted"` (pulsing skeleton circle)
       b) **Signed out** (`!session`): Render `<Button variant="outline" size="sm" onClick={() => signIn("google")}>Sign in</Button>` -- per research, match the app theme, not Google branded button
       c) **Signed in** (`session` exists): Render Avatar + DropdownMenu:
          - Trigger: `<Button variant="ghost" className="relative h-8 w-8 rounded-full">` wrapping `<Avatar className="h-8 w-8">` with `<AvatarImage>` (from `session.user?.image`) and `<AvatarFallback>` (first+last initials from `session.user?.name`)
          - Content (align="end"):
            - `<DropdownMenuLabel>`: user's name (text-sm font-medium) and email (text-xs text-muted-foreground) in a flex-col layout
            - `<DropdownMenuSeparator />`
            - `<DropdownMenuItem disabled>History</DropdownMenuItem>` -- disabled placeholder per discretion recommendation
            - `<DropdownMenuItem disabled>Settings</DropdownMenuItem>` -- disabled placeholder
            - `<DropdownMenuSeparator />`
            - `<DropdownMenuItem onClick={() => signOut()}>Sign out</DropdownMenuItem>` -- no confirmation dialog per discretion recommendation

    2. Update `app/layout.tsx`:
       - Import `AuthButton` from `"@/components/AuthButton"`
       - In the header's inner div (the flex container), replace the lone `<ThemeToggle />` with a wrapping `<div className="flex items-center gap-2">` containing `<AuthButton />` then `<ThemeToggle />`
       - This places the auth button to the left of the theme toggle, both in the top-right area

    3. Run `npm run build` to verify no errors.
  </action>
  <verify>
    - `components/AuthButton.tsx` exists with `"use client"` directive
    - Component uses `useSession`, `signIn("google")`, `signOut()`
    - Component renders Avatar + DropdownMenu when signed in
    - Component renders "Sign in" button when signed out
    - Component renders skeleton circle when loading
    - `app/layout.tsx` includes `<AuthButton />` in the header
    - `npm run build` passes
  </verify>
  <done>
    Header shows sign-in button for unauthenticated users and avatar dropdown for authenticated users. Sign-out is accessible from the dropdown menu. Loading state prevents layout shift with a skeleton circle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SignInHint, history placeholder, and integrate into main page</name>
  <files>
    components/SignInHint.tsx
    app/page.tsx
    app/history/page.tsx
  </files>
  <action>
    1. Create `components/SignInHint.tsx` as a `"use client"` component:
       - Import `useSession` from `"next-auth/react"`
       - If `session` exists or `status === "loading"`, return `null` (only show for signed-out users, and don't flash during loading)
       - Render a subtle hint: `<p className="text-center text-sm text-muted-foreground">Sign in to save transcripts to your history</p>`
       - Keep it minimal -- per locked decision, this is a "subtle hint near transcript output"

    2. Update `app/page.tsx`:
       - Import `SignInHint` from `"@/components/SignInHint"`
       - Add `<SignInHint />` after the transcript output section -- specifically, place it after the closing `</>` of the `appState === 'success'` block, just before the closing `</div>` of the page container
       - This positions the hint below the transcript output, visible when a transcript has been generated

    3. Create `app/history/page.tsx` as a protected server component:
       - Import `auth` from `"@/auth"` and `redirect` from `"next/navigation"`
       - Call `const session = await auth()` and if `!session`, call `redirect("/")`
       - Render a simple placeholder: `<div className="flex flex-col items-center justify-center gap-4 py-16"><h1 className="text-2xl font-semibold">History</h1><p className="text-muted-foreground">Your saved transcripts will appear here.</p></div>`
       - This is a Phase 4 placeholder. The proxy already redirects unauthenticated users, but the server-side check provides defense in depth.

    4. Run `npm run build` to verify no errors.
  </action>
  <verify>
    - `components/SignInHint.tsx` exists, shows hint only when signed out
    - `app/page.tsx` renders `<SignInHint />` near transcript output area
    - `app/history/page.tsx` exists with server-side auth check and redirect
    - `npm run build` passes
  </verify>
  <done>
    Signed-out users see a subtle "Sign in to save transcripts to your history" hint below transcript output. History page exists as a protected route with server-side auth check and placeholder content. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow end-to-end</name>
  <action>
    This is a human verification checkpoint. Claude has automated all code changes in Tasks 1 and 2.

    What was built:
    - Sign-in button in header (top-right, next to theme toggle)
    - Google OAuth redirect flow via Auth.js v5
    - Avatar dropdown with name, email, disabled History/Settings, Sign out
    - Session persistence across page refresh (JWT in HttpOnly cookie)
    - Protected /history route redirecting unauthenticated users
    - "Sign in to save transcripts to your history" hint for signed-out users
  </action>
  <verify>
    Prerequisites: You must have set up Google OAuth credentials and added AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET, and AUTH_SECRET to .env.local.

    1. Start dev server: `npm run dev`
    2. Open http://localhost:3000

    Signed-out state:
    3. Verify "Sign in" button appears in header top-right (next to theme toggle)
    4. Paste any YouTube URL and generate a transcript
    5. Verify "Sign in to save transcripts to your history" hint appears below transcript output
    6. Visit http://localhost:3000/history -- verify redirect back to home page

    Sign-in flow:
    7. Click "Sign in" button in header
    8. Complete Google OAuth consent screen
    9. Verify you return to the same page (home)
    10. Verify the "Sign in" button is replaced by your Google avatar

    Signed-in state:
    11. Click your avatar -- verify dropdown shows your name, email, disabled History and Settings items, and Sign out button
    12. Verify the "Sign in to save..." hint is gone
    13. Visit http://localhost:3000/history -- verify you see the "Your saved transcripts will appear here" placeholder (not redirected)

    Session persistence:
    14. Refresh the page (Cmd+R) -- verify you remain signed in (avatar still showing)
    15. Close the browser tab, reopen http://localhost:3000 -- verify still signed in

    Sign-out:
    16. Click avatar -> Sign out
    17. Verify you return to the page with the "Sign in" button restored
    18. Verify the "Sign in to save..." hint reappears if transcript is visible
  </verify>
  <done>
    Type "approved" if all checks pass, or describe any issues encountered. All 18 verification steps confirm that the complete auth flow works end-to-end: sign in, session persistence, sign out, protected routes, and conditional UI hints.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Header shows "Sign in" button when signed out, avatar when signed in
3. Avatar dropdown shows name, email, disabled History/Settings, and Sign out
4. Clicking "Sign out" signs user out immediately
5. "Sign in to save transcripts to your history" hint appears for signed-out users only
6. /history redirects unauthenticated users to home
7. Session survives page refresh
8. Loading state shows skeleton circle (no layout shift)
</verification>

<success_criteria>
Full auth UI is functional: sign-in button transforms to avatar dropdown on auth, dropdown exposes sign-out and placeholder items, sign-in hint guides unauthenticated users, /history is protected. The complete sign-in -> use -> sign-out flow works end-to-end with Google OAuth.
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation/01-02-SUMMARY.md`
</output>
