---
phase: 04-history-list
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - app/history/[id]/page.tsx
autonomous: true
requirements: [HIST-04]

must_haves:
  truths:
    - "User clicks a history card and sees the full transcript on a dedicated detail page"
    - "Detail page shows video title, thumbnail, save date, and all transcript segments"
    - "User cannot view another user's transcript by guessing the URL"
    - "Non-existent transcript ID shows a 404 page"
    - "User can navigate back to history list from the detail page"
  artifacts:
    - path: "app/history/[id]/page.tsx"
      provides: "Transcript detail page with auth guard, ownership verification, and full transcript rendering"
      min_lines: 30
  key_links:
    - from: "app/history/[id]/page.tsx"
      to: "lib/db/queries.ts"
      via: "getTranscriptById(id, userId) call"
      pattern: "getTranscriptById"
    - from: "app/history/[id]/page.tsx"
      to: "components/TranscriptViewer.tsx"
      via: "renders TranscriptViewer with stored segments"
      pattern: "TranscriptViewer"
    - from: "components/HistoryCard.tsx"
      to: "app/history/[id]/page.tsx"
      via: "Link href to /history/[id]"
      pattern: "history.*id"
---

<objective>
Build the transcript detail page at /history/[id] where users view the full saved transcript. This completes the history browsing flow: list -> click card -> see full transcript.

Purpose: Users need to access their previously saved transcripts in full. The detail page is the payoff of the entire persistence feature.
Output: Working /history/[id] page rendering full transcript with video metadata and navigation back to list.
</objective>

<execution_context>
@/Users/jakesimpson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakesimpson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-history-list/04-RESEARCH.md
@.planning/phases/04-history-list/04-01-SUMMARY.md
@lib/db/queries.ts
@lib/db/schema.ts
@lib/types.ts
@lib/format.ts
@components/TranscriptViewer.tsx
@components/VideoInfo.tsx
@app/history/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build transcript detail page</name>
  <files>
    app/history/[id]/page.tsx
  </files>
  <action>
    Create `app/history/[id]/page.tsx` as an async server component:

    **Imports:** `auth` from `@/auth`, `redirect` and `notFound` from `next/navigation`, `getTranscriptById` from `@/lib/db/queries`, `TranscriptViewer` from `@/components/TranscriptViewer`, `Image` from `next/image`, `Link` from `next/link`, `formatTimestamp` from `@/lib/format`, `ArrowLeft` from `lucide-react`.

    **Next.js 16 async params:** The component signature MUST use `params: Promise<{ id: string }>` and await it: `const { id } = await params;`. This is a Next.js 16 requirement (params is a Promise, not a plain object).

    **Auth guard:** Call `auth()`, redirect to "/" if no session or no user ID.

    **Data fetch:** Call `getTranscriptById(id, session.user.id)` -- this includes ownership verification (query filters by both id AND userId). If result is null, call `notFound()` to render Next.js 404 page.

    **Layout:**
    1. Back navigation: A `Link` to "/history" with ArrowLeft icon and "Back to History" text, styled as subtle link (text-sm text-muted-foreground hover:text-foreground transition-colors, flex items-center gap-1).
    2. Video header section (similar to VideoInfo.tsx pattern):
       - Thumbnail via `next/image` if `thumbnailUrl` is not null (width=200, height=113, unoptimized, rounded-lg). Skip if null.
       - Video title as h1 (text-xl font-semibold)
       - Metadata row: save date formatted with `toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })`, and duration via `formatTimestamp` if `videoDuration` is not null. Separated by a dot or pipe.
    3. Transcript viewer: Render `<TranscriptViewer segments={transcript.segments} showTimestamps={true} />`. TranscriptViewer is a client component that handles segment rendering with ScrollArea. Pass segments directly from the database row (they are typed as TranscriptSegment[] via the JSONB column).

    **Type assertion:** The `segments` column from Drizzle returns `unknown` at runtime for JSONB. Cast it: `transcript.segments as TranscriptSegment[]` (import TranscriptSegment from `@/lib/types`). The schema already has `.$type<TranscriptSegment[]>()` which provides compile-time types, but verify it works without an explicit cast first.

    **Spacing:** Use `space-y-6` for the main container, consistent with the rest of the app's max-w-4xl layout (already handled by layout.tsx main element).
  </action>
  <verify>Run `npx tsc --noEmit` for type checking. Run `npm run build` to confirm the dynamic route compiles. Verify the [id] directory structure is correct for Next.js dynamic routing.</verify>
  <done>Detail page renders at /history/[id] with video metadata, full transcript via TranscriptViewer, back navigation to /history, auth guard, ownership verification, and 404 for missing transcripts. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (dynamic route compiles)
3. `app/history/[id]/page.tsx` exists with auth guard and getTranscriptById call
4. Ownership verification: query uses both `id` and `userId` in where clause
5. `notFound()` called when transcript is null
6. `TranscriptViewer` component rendered with stored segments
7. Back link to /history exists on the detail page
8. Next.js 16 async params pattern used (`await params`)
</verification>

<success_criteria>
- User clicks a history card and sees the full transcript on the detail page
- Detail page displays video title, thumbnail, save date, duration, and all segments
- Back to History link navigates to /history
- Accessing another user's transcript returns 404
- Non-existent transcript ID returns 404
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-history-list/04-02-SUMMARY.md`
</output>
